<!DOCTYPE html>
<html>
  <head>
    <style>
      {
          {
           partial "debugprint.css" | safeCSS
        }
      }
    </style>
    <title>Snack Tracking with the new InfluxDB Arduino Library</title>
    




  





  



<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="X-UA-Compatible" content="ie=edge" />


<link rel="stylesheet" href="/css/bootstrap.min.css"/>
<link rel="stylesheet" href="/css/layouts/main.css"/>
<link rel="stylesheet" href="/css/style.css"/>
<link rel="stylesheet" href="/css/navigators/navbar.css"/>


<link href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" />


<link rel="icon" type="image/png" href="/images/site/favicon_hu0b3af3b2695bc2a8e88d59b9721b8a18_8831_42x0_resize_box_2.png" />


<link rel="stylesheet" href="/css/style.css"/>

    
<meta name="description" content="Snack Tracking with the new InfluxDB Arduino Library" />
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css"
/>
<link rel="stylesheet" href="/css/layouts/single.css"/>
<link rel="stylesheet" href="/css/navigators/sidebar.css">


    
    
  </head>

  <body data-spy="scroll" data-target="#TableOfContents" data-offset="80">
    <div class="container-fluid bg-dimmed wrapper">
      
      
    





  



  





  





  



<nav class="navbar navbar-expand-xl top-navbar final-navbar shadow">
  <div class="container">
      <button class="navbar-toggler navbar-light" id="sidebar-toggler" type="button" onclick="toggleSidebar()">
      <span class="navbar-toggler-icon"></span>
    </button>
    <a class="navbar-brand" href="/">
      <img src="/images/site/main-logo_hu36e4c6c516043df4c5aad6d68b952eee_646582_42x0_resize_box_2.png">David G. Simmons</a>
    <button class="navbar-toggler navbar-light" id="toc-toggler" type="button" onclick="toggleTOC()">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse lang-selector" id="top-nav-items">
      <ul class="navbar-nav ml-auto">
      
      </ul>
    </div>
  </div>
  
  <img src="/images/site/main-logo_hu36e4c6c516043df4c5aad6d68b952eee_646582_42x0_resize_box_2.png" class="d-none" id="main-logo">
  <img src="/images/site/inverted-logo_hu527ca2c923a6347a00483834e2e3046d_608569_42x0_resize_box_2.png" class="d-none" id="inverted-logo">
</nav>



      
      
  <section class="sidebar-section" id="sidebar-section">
    <div class="sidebar-holder">
      <div class="sidebar" id="sidebar">
        <input type="text" value="" placeholder="Search" data-search="" id="search-box" />
        <div class="sidebar-tree">
          <ul class="tree" id="tree">
            <li id="list-heading"><a href="/posts" data-filter="all">Posts</a></li>
            <div class="subtree">
                
  
  
  
  
  
    
    <li><a class="" href="/posts/introduction/introduction/">Introduction</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/mad-skillz/mad-skillz/">Mad Skillz</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/beans/beans/">Coffee Beans</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/hobbies/">Hobbies</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/pranks/">Pranks</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/category/camunda/">Camunda</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/category/general/">General</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/category/programming/">Programming</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/category/dogs/">Dogs</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/category/database/">Databases</a></li>
  

  
  
  
  
  
    
    <li>
      <i class="fas fa-plus-circle"></i><a class="" href="/posts/category/iot/">IoT</a>
      
      <ul class="">
        
  
  
  
  
  
    
    <li><a class="" href="/posts/category/iot/iot-hardware/">Hardware</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/category/iot/iot-software/">Software</a></li>
  


      </ul>
    </li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/work/">Work</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/category/devrel/">DevRel</a></li>
  


            </div>
          </ul>
        </div>
      </div>
    </div>
  </section>


      
      
<section class="content-section" id="content-section">
  <div class="content">
    <div class="container p-0 read-area">
      
      
      
        
        
        
        
        






























&#34;https://davidgs.com/posts/category/database/images/Screen-Shot-2020-03-13-at-2.26.15-PM.png&#34;








        <div class="hero-area col-sm-12" id="hero-area" style='background-image: url(https://davidgs.com/posts/category/database/images/Screen-Shot-2020-03-13-at-2.26.15-PM.png);'>
      </div>
      


      
      <div class="page-content">
        <div class="author-profile ml-auto align-self-lg-center">
          <img class="rounded-circle" src='/images/author/dg3.png'/>
          <h5 class="author-name">David G. Simmons</h5>
          <p>March 13, 2020</p>
        </div>

        <div class="title">
          <h1>Snack Tracking with the new InfluxDB Arduino Library</h1>
        </div>

        <div class="post-content" id="post-content">


          <h2 id="a-new-library">A New Library</h2>
<p>Many of you Arduino enthusiasts are probably aware of the existing InfluxDB library that was maintained by <a href="https://github.com/tobiasschuerg">Tobias Schürg</a> for many years. Hats are off to him for providing this library and maintaining it for so long.</p>
<p>With the arrival of InfluxDB 2.0, it was time to update the library. Some of you may remember that I did a quick update to support the InfluxDB 2.0 OSS a few months ago, and that was working well, but InfluxData has been working towards a set of consistent, InfluxData-maintained set of client libraries. They have been working with Tobias over the last couple of months to update his library with our newest changes, and become a maintainer of that library. I&rsquo;m glad to say that all of that work has paid off, and the new InfluxDB Arduino Library is officially released, and is also part of the <a href="https://v2.docs.influxdata.com/v2.0/reference/api/client-libraries/">docs</a>.</p>
<h2 id="some-significant-additions">Some Significant Additions</h2>
<p>This new version of the library, while backward-compatible with the older version (mostly) has some really significant changes for the 2.0 version of InfluxDB while still supporting the 1.x line.</p>
<p>Batch writing is still supported, but it is <strong>much</strong> more seamless and efficient. I&rsquo;ve been working with it a bit, and there is no longer a need to keep a batch counter and write out the batch manually. It&rsquo;s all handled for you. Possibly most significantly is the ability to keep the HTTP connection alive, which saves the overhead of instantiating the connection and tearing it down repeatedly. As long as you have reliable WiFi, that is.</p>
<p>There is now support for handling database back pressure. If your writes don&rsquo;t go through, the library will cache the writes that didn&rsquo;t succeed and try them again, and the size of the back pressure cache is configurable.</p>
<p>There is now an easy way to handle time stamps and time synchronization within the library itself. You can set the time precision, and the library automatically handles the time stamping for you.</p>
<p>There&rsquo;s much more, I&rsquo;m sure (including handling SSL connections) that I haven&rsquo;t gotten to work with yet, but I&rsquo;m sure I&rsquo;ll get a chance to soon!</p>
<h2 id="a-snack-tracker">A Snack Tracker</h2>
<p>Given that this new library just came out, I figured I would put it through its paces at least once right away. In order to do so, I wanted to write a <em>lot</em> of data through it to see how it held up. In order to do that, I went out and bought a little <a href="https://www.amazon.com/gp/product/B07SX2MYMX/">DYI Digital Scale</a> that uses an HX711 to interface to the Load Cell. I then hooked that to a WEMOS D1 Mini (of course, since I have so many of them around), and I was ready to go! I wired it up:</p>
<p><img src="/posts/category/database/images/Snacker.png" alt="Snacker"></p>
<p>The Arduino Library for the HX711 came with a sample program for calibrating the scales, and I sort of anticipated having to calibrate them, so I bought a set of calibration weights when I bought the scale. The Calibration program even saves the calibration data to the EEPROM for you so it is always calibrated. It looks like it&rsquo;s accurate to within about 0.05 grams, for the most part.</p>
<h2 id="code-time">Code Time</h2>
<p>Now that the device was built, it was time to write a bit of code to send all this data to InfluxDB! Luckily the HX711 library also came with a sample program for just spewing out raw data from the device, so all I had to do was modify that ever so slightly to send my data to InfluxDB.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// InfluxDB 2 server url, e.g. http://192.168.1.48:9999 (Use: InfluxDB UI -&gt; Load Data -&gt; Client Libraries)
</span><span style="color:#75715e"></span><span style="color:#75715e">#define INFLUXDB_URL &#34;influxdb-url&#34;
</span><span style="color:#75715e"></span><span style="color:#75715e">// InfluxDB 2 server or cloud API authentication token (Use: InfluxDB UI -&gt; Load Data -&gt; Tokens -&gt; &lt;select token&gt;)
</span><span style="color:#75715e"></span><span style="color:#75715e">#define INFLUXDB_TOKEN &#34;token&#34;
</span><span style="color:#75715e"></span><span style="color:#75715e">// InfluxDB 2 organization name or id (Use: InfluxDB UI -&gt; Settings -&gt; Profile -&gt; &lt;name under tile&gt; )
</span><span style="color:#75715e"></span><span style="color:#75715e">#define INFLUXDB_ORG &#34;org&#34;
</span><span style="color:#75715e"></span><span style="color:#75715e">// InfluxDB 2 bucket name (Use: InfluxDB UI -&gt; Load Data -&gt; Buckets)
</span><span style="color:#75715e"></span><span style="color:#75715e">#define INFLUXDB_BUCKET &#34;bucket&#34;
</span><span style="color:#75715e"></span>
InfluxDBClient <span style="color:#a6e22e">client</span>(INFLUXDB_URL, INFLUXDB_ORG, INFLUXDB_BUCKET, INFLUXDB_TOKEN);

HX711_ADC <span style="color:#a6e22e">LoadCell</span>(D1, D2);
</code></pre></div><p>You will, of course, have to define your own URL, TOKEN, etc. I put the load cell on D1 and D2, so that&rsquo;s defined here too.</p>
<p>I then added the following to the end of the setup() routine:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// Synchronize UTC time with NTP servers
</span><span style="color:#75715e">// Accurate time is necessary for certificate validaton and writing in batches
</span><span style="color:#75715e"></span>configTime(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#34;pool.ntp.org&#34;</span>, <span style="color:#e6db74">&#34;time.nis.gov&#34;</span>);
<span style="color:#75715e">// Set timezone
</span><span style="color:#75715e"></span>setenv(<span style="color:#e6db74">&#34;TZ&#34;</span>, <span style="color:#e6db74">&#34;EST5EDT&#34;</span>, <span style="color:#ae81ff">1</span>;
influx.setWriteOptions(WritePrecision<span style="color:#f92672">::</span>MS, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">60</span>, true);
</code></pre></div><p>That sets up the time synchronization, and sets my time precision to milliseconds, sets the batch size, the buffer size (which in my case I set to 3x the batch size), the flush interval (I make sure the a flush happens at least every 60 seconds) and I set the http-keepalive to true so I can just use the same connection every time.</p>
<p>That was all the setup I had to do!</p>
<p>Next, I need to write the data. And here&rsquo;s the thing, the HX711 example program reads the scale every 250ms</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">float</span> weight <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.00</span>;
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loop</span>() {
   <span style="color:#75715e">//update() should be called at least as often as HX711 sample rate; &gt;10Hz@10SPS, &gt;80Hz@80SPS
</span><span style="color:#75715e"></span>  <span style="color:#75715e">//use of delay in sketch will reduce effective sample rate (be carefull with use of delay() in the loop)]{style=&#34;color: #999dab;&#34;}
</span><span style="color:#75715e"></span>  LoadCell.update();
  <span style="color:#75715e">//get smoothed value from data set
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(millis() <span style="color:#f92672">&gt;</span> t <span style="color:#f92672">+</span> <span style="color:#ae81ff">250</span>) {
    <span style="color:#66d9ef">float</span> i <span style="color:#f92672">=</span> LoadCell.getData();
    weight <span style="color:#f92672">=</span> i;
    t <span style="color:#f92672">=</span> millis();
  }
  writeData(weight);
  ...
}
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">writeData</span>(<span style="color:#66d9ef">float</span> weight) {
  Point dPoint();
  dPoint.addTag(<span style="color:#e6db74">&#34;device&#34;</span>, <span style="color:#e6db74">&#34;ESP8266&#34;</span>);
  dPoint.addTag(<span style="color:#e6db74">&#34;sensor&#34;</span>, SENSOR_ID);
  dPoint.addField(<span style="color:#e6db74">&#34;weight&#34;</span>, weight);
  Serial.print(<span style="color:#e6db74">&#34;Weight: &#34;</span>);
  Serial.println(weight);
  <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>influx.writePoint(dPoint)) {
    Serial.print(<span style="color:#e6db74">&#34;InfluxDB write failed: &#34;</span>);
    Serial.println(influx.getLastErrorMessage());
  }
</code></pre></div><p>In the above code I&rsquo;m writing a new data point, with tags, etc., every ~250ms. You&rsquo;ll notice that I just keep writing the data points. But in the background, the library is handling the batching, caching, back-pressure, retries, etc. I just get to merrily write datapoints without thinking about them anymore.</p>
<h2 id="gummy-bears">Gummy Bears</h2>
<p>If you know me at all, you&rsquo;ll also know that I have sort of a <em>thing</em> for gummy bears. So I decided to test this thing out by loading it up with a bowl of gummy bears, and watching the data as I ate them. Lo and behold, it works!</p>
<p><img src="/posts/category/database/images/Gummies2.gif" alt="Gummies2"></p>
<p>You can see that when I stick my hand in the bowl to get some, the weight goes up just a bit, then drops. Of course I had to make a Gummy Bear Dashboard:</p>
<p><img src="/posts/category/database/images/GummyDash.gif" alt="GummyDash"></p>
<p>Which was really kind of fun, until I ran out of Gummy Bears.</p>
<p><img src="/posts/category/database/images/Screen-Shot-2020-03-13-at-2.26.15-PM.png" alt="Screen Shot 2020 03 13 at 2 26 15 PM"></p>
<p>So far this thing has been running for a couple of hours and I have yet to see a single error message or hiccup from the device itself, so it looks like the batching, cacheing, etc. is all working perfectly.</p>

        
        

        
        
        
        


        


        
        
        
        
        
        
          
        
        
        </div>

        
        
          <div class="btn-improve-page">
              <a href="https://github.com/davidgs/website/edit//content/posts/category/database/snack-tracking-with-the-new-influxdb-arduino-library.md">
                <i class="fas fa-code-branch"></i>
                Improve this page
              </a>
          </div>
        

        
      <hr />
        <div class="row next-prev-navigator">


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
      
      <div class="col-md-6 previous-article">
        <a href="/posts/category/database/all-that-corona-virus-data/" class="btn btn-outline-info">
          <span><i class="fas fa-chevron-circle-left"></i> Prev</span>
          <br />
          <span>All That Corona Virus Data</span>
        </a>
      </div>
      
    
    
      
        
        
          
              
          
        
        <div class="col-md-6 next-article">
          <a href="/posts/category/iot/this-whole-thing-stinks/" class="btn btn-outline-info">
            <span>Next <i class="fas fa-chevron-circle-right"></i></span>
            <br />
            <span>This Whole Thing Stinks!</span>
          </a>
        </div>
      
    
  

  

  

  

  

  

  

  

  

  

  

</div>

      <hr />
      
      
      </div>
    </div>
  </div>
  
</section>


      
      
  <section class="toc-section" id="toc-section">
    
    <div class="toc-holder">
      <h5 class="text-center pl-3">Table of Contents</h5>
      <hr>
      <div class="toc">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#a-new-library">A New Library</a></li>
    <li><a href="#some-significant-additions">Some Significant Additions</a></li>
    <li><a href="#a-snack-tracker">A Snack Tracker</a></li>
    <li><a href="#code-time">Code Time</a></li>
    <li><a href="#gummy-bears">Gummy Bears</a></li>
  </ul>
</nav>
      </div>
    </div>
    
  </section>

    </div>

    

  




  




  
  
    
  









  







<footer class="container-fluid text-center align-content-center footer pb-2">
  <div class="container pt-5">
    <div class="row text-left">
      <div class="col-md-4 col-sm-12">
        <h5>Navigation</h5>
        
        <ul>
            
              
              
                
              
              <li class="nav-item">
                <a class="smooth-scroll" href="#about">About</a>
              </li>
            
            
              
              
                
              
              <li class="nav-item">
                <a class="smooth-scroll" href="#skills">Skills</a>
              </li>
            
            
              
              
                
              
              <li class="nav-item">
                <a class="smooth-scroll" href="#experiences">Experience</a>
              </li>
            
            
              
              
                
              
              <li class="nav-item">
                <a class="smooth-scroll" href="#education">Education</a>
              </li>
            
            
              
              
                
              
              <li class="nav-item">
                <a class="smooth-scroll" href="#projects">Projects</a>
              </li>
            
            
              
              
                
              
              <li class="nav-item">
                <a class="smooth-scroll" href="#recent-posts">Recent Posts</a>
              </li>
            
        </ul>
        

      </div>
      
      <div class="col-md-4 col-sm-12">
        <h5>Contact me:</h5>
        <ul>
          
          <li><span>Email: </span> <span>davidgs@davidgs.com</span></li>
          
          <li><span>Phone: </span> <span>&#43;1 (919) 534-5099</span></li>
          
        </ul>
      </div>
      
      
      <div class="col-md-4 col-sm-12">
        
        <p>Stay up to date with email notification</p>
        <form>
          <div class="form-group">
            <input
              type="email"
              class="form-control"
              id="exampleInputEmail1"
              aria-describedby="emailHelp"
              placeholder="Enter email"
            />
            <small id="emailHelp" class="form-text text-muted"
              >We&#39;ll never share your email with anyone else.</small
            >
          </div>
          <button type="submit" class="btn btn-info">Submit</button>
        </form>
      </div>
      
    </div>
  </div>
  <hr />
  <div class="container">
    <div class="row text-left">
      <div class="col-md-4">
        <a id="theme" href="https://github.com/hossainemruz/toha" target="#">
          <img src="/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_2.png">
          Toha
        </a>
      </div>
      <div class="col-md-4 text-center">© 2020 Copyright.</div>
      <div class="col-md-4 text-right">
        <a id="hugo" href="https://gohugo.io/">Powered by
        <img
          src="/images/hugo-logo.svg"
          alt="Hugo Logo"
          height="18"
        />
        </a>
      </div>
    </div>
  </div>
</footer>

    <script src="/js/jquery-3.4.1.min.js"></script>
<script src="/js/popper.min.js"></script>
<script src="/js/bootstrap.min.js"></script>

<script src="/js/navbar.js"></script>
<script src="/js/main.js"></script>


    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>
<script src="/js/single.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>



    
    
<script type="text/javascript">
  var sc_project = 4739013;
  var sc_invisible = 0;
  var sc_security = "3147012e";
  var scJsHost = "https://";
  document.write("<sc" + "ript type='text/javascript' src='" +
    scJsHost +
    "statcounter.com/counter/counter.js'></" + "script>");
</script>
<noscript>
  <div class="statcounter"><a title="Web Analytics
Made Easy - StatCounter" href="https://statcounter.com/" target="_blank"><img class="statcounter"
        src="https://c.statcounter.com/4739013/0/3147012e/0/" alt="Web Analytics Made Easy -
StatCounter"></a></div>
</noscript>

  </body>
</html>
