<!DOCTYPE html>
<html>
  <head>
    <style>
      {
          {
           partial "debugprint.css" | safeCSS
        }
      }
    </style>
    <title>Building an InfluxDB IoT Edge Data Collection Device</title>
    




  





  



<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="X-UA-Compatible" content="ie=edge" />


<link rel="stylesheet" href="/css/bootstrap.min.css"/>
<link rel="stylesheet" href="/css/layouts/main.css"/>
<link rel="stylesheet" href="/css/style.css"/>
<link rel="stylesheet" href="/css/navigators/navbar.css"/>


<link href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" />


<link rel="icon" type="image/png" href="/images/site/favicon_hu0b3af3b2695bc2a8e88d59b9721b8a18_8831_42x0_resize_box_2.png" />


<link rel="stylesheet" href="/css/style.css"/>

    
<meta name="description" content="Building an InfluxDB IoT Edge Data Collection Device" />
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css"
/>
<link rel="stylesheet" href="/css/layouts/single.css"/>
<link rel="stylesheet" href="/css/navigators/sidebar.css">


    
    
  </head>

  <body data-spy="scroll" data-target="#TableOfContents" data-offset="80">
    <div class="container-fluid bg-dimmed wrapper">
      
      
    





  



  





  





  



<nav class="navbar navbar-expand-xl top-navbar final-navbar shadow">
  <div class="container">
      <button class="navbar-toggler navbar-light" id="sidebar-toggler" type="button" onclick="toggleSidebar()">
      <span class="navbar-toggler-icon"></span>
    </button>
    <a class="navbar-brand" href="/">
      <img src="/images/site/main-logo_hu36e4c6c516043df4c5aad6d68b952eee_646582_42x0_resize_box_2.png">David G. Simmons</a>
    <button class="navbar-toggler navbar-light" id="toc-toggler" type="button" onclick="toggleTOC()">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse lang-selector" id="top-nav-items">
      <ul class="navbar-nav ml-auto">
      
      </ul>
    </div>
  </div>
  
  <img src="/images/site/main-logo_hu36e4c6c516043df4c5aad6d68b952eee_646582_42x0_resize_box_2.png" class="d-none" id="main-logo">
  <img src="/images/site/inverted-logo_hu527ca2c923a6347a00483834e2e3046d_608569_42x0_resize_box_2.png" class="d-none" id="inverted-logo">
</nav>



      
      
  <section class="sidebar-section" id="sidebar-section">
    <div class="sidebar-holder">
      <div class="sidebar" id="sidebar">
        <input type="text" value="" placeholder="Search" data-search="" id="search-box" />
        <div class="sidebar-tree">
          <ul class="tree" id="tree">
            <li id="list-heading"><a href="/posts" data-filter="all">Posts</a></li>
            <div class="subtree">
                
  
  
  
  
  
    
    <li><a class="" href="/posts/introduction/introduction/">Introduction</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/mad-skillz/mad-skillz/">Mad Skillz</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/beans/beans/">Coffee Beans</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/hobbies/">Hobbies</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/pranks/">Pranks</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/category/camunda/">Camunda</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/category/general/">General</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/category/programming/">Programming</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/category/dogs/">Dogs</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/category/database/">Databases</a></li>
  

  
  
  
  
  
    
    <li>
      <i class="fas fa-plus-circle"></i><a class="" href="/posts/category/iot/">IoT</a>
      
      <ul class="">
        
  
  
  
  
  
    
    <li><a class="" href="/posts/category/iot/iot-hardware/">Hardware</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/category/iot/iot-software/">Software</a></li>
  


      </ul>
    </li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/work/">Work</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/category/devrel/">DevRel</a></li>
  


            </div>
          </ul>
        </div>
      </div>
    </div>
  </section>


      
      
<section class="content-section" id="content-section">
  <div class="content">
    <div class="container p-0 read-area">
      
      
      
        
        
        
        
        






























&#34;https://davidgs.com/posts/category/iot/iot-hardware/images/IMG_4086.png&#34;








        <div class="hero-area col-sm-12" id="hero-area" style='background-image: url(https://davidgs.com/posts/category/iot/iot-hardware/images/IMG_4086.png);'>
      </div>
      


      
      <div class="page-content">
        <div class="author-profile ml-auto align-self-lg-center">
          <img class="rounded-circle" src='/images/author/dg3.png'/>
          <h5 class="author-name">David G. Simmons</h5>
          <p>July 20, 2018</p>
        </div>

        <div class="title">
          <h1>Building an InfluxDB IoT Edge Data Collection Device</h1>
        </div>

        <div class="post-content" id="post-content">


          <p>I’ve been saying I was going to write this whole project up for some time now but it has been such a daunting task that I’ve been putting it off, starting and stopping, and generally not getting it done for a few months. Finally, I have it! This is both a hardware build and a software build, and there are a <strong>lot</strong> of moving parts, so be prepared!</p>
<h2 id="overview">Overview</h2>
<p>I wanted to build a demonstration system that would show off the capabilities of using InfluxData — the entire TICK Stack — on the extreme edge of an IoT Architecture. While a lot of companies are betting on the cloud for IoT data collection, I understand that for some — especially in the Industrial IoT space — a cloud-first strategy is simply a non-starter. Furthermore, with a wide variety of network connectivity modalities — WiFi, BLE, LoRAWAN, etc. — being deployed, at some point you simply have to have an edge device to connect to your end-sensors. In essence, I wanted to pull this architecture diagram together in real life.</p>
<p><img src="/posts/category/iot/iot-hardware/images/architecture.gif" alt="Architecture"></p>
<p>So I had to build a bunch of sensors, and then build an edge data collection box, and then hook it up to the internet and have it back-haul data to the cloud. Let’s start with the sensor builds.</p>
<h2 id="the-hardware">The Hardware</h2>
<p>As stated above, I wanted to incorporate as many sensors , and communication protocols, as I could in order to cover the widest possible deployment scenario. I ended up building a CO2 sensor connected over BlueTooth Low Energy (BLE), a temperature, humidity, pressure, visible light and Infrared sensor connected over WiFi, a radiation sensor connected over LoRAWAN and a contactless temperature sensor also connected over LoRaWan. That’s a lot of sensors to build, and a lot of RF protocols to incorporate.</p>
<h3 id="the-wifi-sensor">The WiFi Sensor</h3>
<p>Let’s tackle this one first, shall we? Here is the parts list you need to build this one:</p>
<ul>
<li><a href="https://store.particle.io">Particle Photon</a></li>
<li>Bosch BME280 (I got mine from <a href="https://www.adafruit.com/product/2652">Adafruit</a>)</li>
<li><a href="https://www.adafruit.com/product/2652">Adafruit TLS2561</a> Light sensor</li>
</ul>
<p>I used I2C to hook them up, since it used the fewest pins, and I could share the pins. Here’s the wiring Diagram:</p>
<p><img src="/posts/category/iot/iot-hardware/images/Wiring.png" alt="Wiring"></p>
<p>I wired them to my Particle Photon and wrote a little bit of software. We’ll get to that in the Software Section, but it was fairly trivial to do given that Particle devices are programmed in an Arduino-like language and are fairly straightforward to handle.</p>
<p>I 3-D printed a nice box for it, and used super-thin ceramic-coated wire to solder it all together so it came out in a nice package:</p>
<p><img src="/posts/category/iot/iot-hardware/images/IMG_4090.png" alt="IMG 4090"></p>
<p><img src="/posts/category/iot/iot-hardware/images/IMG_4089.png" alt="IMG 4089"></p>
<p><img src="/posts/category/iot/iot-hardware/images/IMG_4092.png" alt="IMG 4092"></p>
<p>The sensor boards are hung from the insides, in front of the ventilation holes, so that they can get accurate (sort of) readings.</p>
<h3 id="the-ble-cosub2sub-sensor">The BLE CO<sub>2</sub> Sensor</h3>
<p>This one was a bit more of a challenge for a few reasons. But first the parts list:</p>
<ul>
<li>Nordic nRF52DK developer Kit (I got mine from <a href="https://www.digikey.com/product-detail/en/nordic-semiconductor-asa/NRF52-DK/1490-1053-ND/5773879?utm_adgroup=Semiconductor%20Modules&amp;slid=&amp;gclid=EAIaIQobChMIvJTLptKr3AIVSsDICh0z8QCnEAAYASAAEgJg-PD_BwE">DigiKey</a>)</li>
<li><a href="https://senseair.com/products/flexibility-counts/k30/">SenseAir K30</a> CO<sub>2</sub> sensor</li>
<li>4700µF Capacitor(<a href="https://www.adafruit.com/product/1589">Adafruit</a> to the rescue again!)</li>
<li>9v Boost Converter (I got mine from <a href="https://www.pololu.com/product/2116">Pololu</a>)</li>
</ul>
<p>To make things a little less complicated, I wired the Boost to the nRF52, and then put the capacitor on the vout of the boost like this:</p>
<p><img src="/posts/category/iot/iot-hardware/images/IMG_4100.png" alt="IMG 4100"></p>
<p>I’m not certain it made things <em>easier</em> per se, but it was how I did it anyway. If you’re an electrical engineer, and are laughing right now, feel free to get in touch and point out the error of my ways.</p>
<p>I’ll get in to it more in the software sections, but this one was a bit of a beast to control. First off, <strong>DO NOT</strong> use this sensor wired directly to an Arduino! It absolutely <strong>will</strong> eat your voltage regulator. It requires 5v-12v and 500mA and according to the manufacturer, there isn’t an Arduino out there with a regulator that can handle it. The nRF52DK board claims that they can, but I’m skeptical of that claim to some degree.</p>
<p>Again, I 3-D printed a nice box, with vent holes in the top to allow for airflow.</p>
<p><img src="/posts/category/iot/iot-hardware/images/IMG_4087.png" alt="IMG 4087"></p>
<p><img src="/posts/category/iot/iot-hardware/images/IMG_4096.png" alt="IMG 4096"></p>
<p>I keep looking for a smaller BLE-based board to drive this thing — one that does not run Arduino — but I’ve yet to find the right one.</p>
<h3 id="the-lora-radiation-sensor">The LoRa Radiation Sensor</h3>
<p>This one was super fun to build. I grew up in Los Alamos, NM (The Atomic City!), so there’s that. But I had been invited to present at a workshop in Italy hosted by the United Nations International Atomic Energy Agency on “Radiation Monitoring over LoRaWAN” so I just <strong>had</strong> to build a radiation sensor! (It was really neat, and I blogged about it <a href="https://www.influxdata.com/blog/influxdb-the-united-nations-and-radiation/">here</a>)</p>
<p>Here’s what I used:</p>
<ul>
<li>Pocket Geiger Radiation Sensor (from <a href="https://www.sparkfun.com/products/14209">SparkFun Electronics</a>)</li>
<li><a href="https://www.aliexpress.com/store/product/D1-mini-Mini-NodeMcu-4M-bytes-Lua-WIFI-Internet-of-Things-development-board-based-ESP8266/1331105_32529101036.html?spm=2114.12010612.8148356.13.38593ca0eqsbug">Wemos D1 Mini</a> (I do <strong>not</strong> recommend the D1 Mini Pro as all the ones I bought had faulty WiFi and were unusable, though I did not use the WiFi for these parts)</li>
<li>LoRa Radio Board (from <a href="https://www.adafruit.com/product/3072">Adafruit</a>, of course)</li>
<li>A White LED</li>
</ul>
<p>You’re probably asking yourself why I used a Wemos D1 (which has WiFi) inside this thing that is using a LoRa radio, and I’ll tell you why: I couldn’t find a cheaper board to control the LoRa Radio Board <strong>and</strong> the sensor board. At $3.00 it was just the right thing. I just turned the WiFi off and went with it.</p>
<p>For the LED I just used one I had lying around. No idea where it came from.</p>
<p>This one came out really nicely!</p>
<p><img src="/posts/category/iot/iot-hardware/images/IMG_4084.png" alt="IMG 4084"></p>
<p>As you can see, it took a fair amount of work to get everything in the box, what with all the wires, etc. but it all managed to fit snugly.</p>
<p><img src="/posts/category/iot/iot-hardware/images/IMG_4101.png" alt="IMG 4101"></p>
<h3 id="the-contactless-temperature-sensor">The Contactless Temperature Sensor</h3>
<p>Again, super simple.</p>
<ul>
<li>Wemos D1 Mini (see above)</li>
<li>LoRad Radio Board (see above)</li>
<li>Melexis MLX90614 sensor (You can get one from <a href="https://www.adafruit.com/product/1748">Adafruit</a>)</li>
<li>A green LED</li>
</ul>
<p>I’ll admit that you can’t get the same Melexis sensor that I used but that’s because way back in the day, back in the <a href="http://sunspotdev.org/">Project Sun SPOT</a> days, we built a little sensor board for the MLX90614 that made it easy to use over I2C. I happen to have a few of those lying around (from like 2006!), so I used one. Again, I used the Wemos D1 Mini, with the WiFi radio turned off, to control both the sensor and the LoRa Board simply because it was cheap (and I had a bunch of Wemos D1 Mini Pros lying around with Wifi that didn’t work anyway. Remember, don’t buy those.)</p>
<p>Same thing with the Green LED. Just had one lying around.</p>
<p>Here’s the Temperature sensor board you can’t have:
<img src="/posts/category/iot/iot-hardware/images/IMG_3699.png" alt="IMG 3699"></p>
<p>And here’s the final package:</p>
<p><img src="/posts/category/iot/iot-hardware/images/IMG_4094-1.png" alt="IMG 4094 1"></p>
<p>Again, getting all the wires in took some nifty soldering and packaging, but it all managed to fit in the end:</p>
<p><img src="/posts/category/iot/iot-hardware/images/IMG_3714.png" alt="IMG 3714"></p>
<p>So that concludes the sensor hardware. Now, on to the Edge Data Collection Node Hardware!</p>
<h2 id="building-the-edge-collector">Building the Edge Collector</h2>
<p>I admit that I could have used a Raspberry Pi. But honestly I’d backed the Pine-64 on Kickstarter and I hadn’t used the board for anything, so I decided to use it. Also, finding screens and cases for Raspberry Pis is easy, I guess, but there are so many of them that it was hard to choose, and Pine64 has it all in one place.</p>
<p>Here’s what I needed for the build:</p>
<ul>
<li><a href="https://www.pine64.org/?product=pine-a64-lts">Pine-64 LTS</a> Main Board ($32.00)</li>
<li><a href="https://www.pine64.org/?product=wifi-802-11bgn-bluetooth-4-0-module">WiFi/BLE card</a> ($9.99)</li>
<li><a href="https://www.pine64.org/?product=7-lcd-touch-screen-panel">7” TFT Touchscreen</a> ($35.99)</li>
<li><a href="https://www.pine64.org/?product=pine64-playbox-enclosure">Pine64 Playbox Enclosure</a> ($9.99)</li>
<li><a href="https://www.pine64.org/?product=lithium-polymer-battery-us-only">LiPo Battery</a> ($21.99)</li>
<li>LoRa Board (see above)</li>
<li>Wemos D1 Mini (see above)</li>
</ul>
<p>Optional but recommended</p>
<ul>
<li>64GB EMMC Module ($34.95)</li>
</ul>
<p>I actually used a 64GB MicroSSD card in mine, but the location of the card slot is so awful that I ended up breaking one and having to replace it. If I had to build another one, I’d use the EMMC Module for sure.</p>
<p>I’m sure you’re scratching your head and thinking “Why is there a Wemos D1 in this bit of kit??” And I’ll tell you! Again, it’s just to control the LoRa board. Yes, I absolutely could have controlled it from the Pine64, but I already had all the working code to control the LoRa board from a Wemos, and it’s small and takes up very little space, so I just powered it off the 5v pin on the RPi header and was good to go. I wired it’s UART Tx pin to the RPi header’s Rx pin and simply wrote any data coming in over the LoRa Radio to the Pine-64’s incoming serial port where I could then pick it up and store it.</p>
<p>I think it came out pretty nice!</p>
<p><img src="/posts/category/iot/iot-hardware/images/IMG_4086.png" alt="IMG 4086"></p>
<p>Again, all the wires were a bit much, and I had to drill an extra hole in the case to mount the LoRa antenna, but even the inside looked nice:</p>
<p><img src="/posts/category/iot/iot-hardware/images/IMG_3705-1.png" alt="IMG 3705 1"></p>
<p>There’s actually a ZWave module in there too, but only because it came with my Kickstarter Bundle. I’m not actually using it yet.</p>
<p>Now, how did I get that slick looking dashboard of all my sensor data on there? Well, that’s actually the easiest part of the software build, so let’s get to the software!</p>
<h2 id="the-software">The Software</h2>
<p>I’ll go through the software I built in the same order as the hardware, just for consistency’s sake. Fell free to jump around to the parts that interest you the most.</p>
<h3 id="the-wifi-sensor-1">The WiFi Sensor</h3>
<p>Programming the Particle Photons is super easy using their web-based development environment. They have a Desktop version too, based on Atom, but I had regular problems with it so I stuck to the on-line one. One of the few drawbacks to Particle is that they expect everything to go through their cloud, but their cloud has no way of storing and analyzing data. A rather large weakness, if you ask me. But even if it didn’t, I’d have had to do things this way because, as stated earlier, I didn’t want to do a cloud-first architecture. I wanted the edge device to collect the data. I wanted to connect to a private WiFi network (served up by the edge device itself) and send all my data there.</p>
<p>It turns out that the first thing a Particle Photon always tries to do is contact the Particle Cloud. If it can’t, then things get weird. So the very first thing I had to do was tell it to please stop doing that!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">Particle.disconnect();
WiFi.connect();
</code></pre></div><p>That stops that! And then connects me to my private WiFi. (You have to configure this via a USB connection to your Photon!).</p>
<p>Here’s all the code, and I can then go through it in more detail:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// This #include statement was automatically added by the Particle IDE.
</span><span style="color:#75715e"></span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;HttpClient.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">// This #include statement was automatically added by the Particle IDE.
</span><span style="color:#75715e"></span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;Adafruit_TSL2561_U.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;Adafruit_Sensor.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;Adafruit_BME280.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e">#define SEALEVELPRESSURE_HPA (1013.25)
</span><span style="color:#75715e">#define TELEGRAF_HOST &#34;192.168.3.1&#34;
</span><span style="color:#75715e">#define TELEGRAF_PORT 1619
</span><span style="color:#75715e">#define temp(x) String(x)
</span><span style="color:#75715e"></span>
<span style="color:#75715e">//the two sensors
</span><span style="color:#75715e"></span>Adafruit_BME280 bme;
Adafruit_TSL2561_Unified tsl <span style="color:#f92672">=</span> Adafruit_TSL2561_Unified(TSL2561_ADDR_FLOAT, <span style="color:#ae81ff">12345</span>);

<span style="color:#75715e">// some variables
</span><span style="color:#75715e"></span><span style="color:#66d9ef">double</span> temperature <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.00</span>;
<span style="color:#66d9ef">double</span> pressure <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.00</span>;
<span style="color:#66d9ef">double</span> altitude <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.00</span>;
<span style="color:#66d9ef">double</span> humidity <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.00</span>;
<span style="color:#66d9ef">uint16_t</span> broadband <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
<span style="color:#66d9ef">uint16_t</span> infrared <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
<span style="color:#66d9ef">int</span> lux <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
String myID <span style="color:#f92672">=</span> System.deviceID();
String myName <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;DemoKit3&#34;</span>;
<span style="color:#66d9ef">bool</span> bme_config <span style="color:#f92672">=</span> true;
<span style="color:#66d9ef">bool</span> tsl_config <span style="color:#f92672">=</span> true;

<span style="color:#75715e">// http stuff
</span><span style="color:#75715e"></span>http_request_t request;
http_response_t response;
HttpClient http;

SYSTEM_MODE(SEMI_AUTOMATIC);

<span style="color:#66d9ef">int</span> led <span style="color:#f92672">=</span> D7;

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setup</span>() {
    delay(<span style="color:#ae81ff">2000</span>);
    Serial.begin(<span style="color:#ae81ff">115200</span>);
    Serial.println(<span style="color:#e6db74">&#34;No Cloud! Not using Particle.&#34;</span>);
    Particle.disconnect();
    delay(<span style="color:#ae81ff">2000</span>);
    Serial.print(<span style="color:#e6db74">&#34;Connecting to WiFi ... &#34;</span>);
<span style="color:#75715e">// this is all debug stuff that helped me get the WiFi working properly
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(WiFi.hasCredentials()){
        Serial.println(<span style="color:#e6db74">&#34;Found credentials&#34;</span>);
        WiFiAccessPoint ap[<span style="color:#ae81ff">5</span>];
        <span style="color:#66d9ef">int</span> found <span style="color:#f92672">=</span> WiFi.getCredentials(ap, <span style="color:#ae81ff">5</span>);
        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> found; i<span style="color:#f92672">++</span>) {
            Serial.print(<span style="color:#e6db74">&#34;ssid: &#34;</span>);
            Serial.println(ap[i].ssid);
<span style="color:#75715e">// security is one of WLAN_SEC_UNSEC, WLAN_SEC_WEP, WLAN_SEC_WPA, WLAN_SEC_WPA2, WLAN_SEC_WPA_ENTERPRISE, WLAN_SEC_WPA2_ENTERPRISE
</span><span style="color:#75715e"></span>            Serial.print(<span style="color:#e6db74">&#34;security: &#34;</span>);
            Serial.println(ap[i].security);
<span style="color:#75715e">// cipher is one of WLAN_CIPHER_AES, WLAN_CIPHER_TKIP or WLAN_CIPHER_AES_TKIP
</span><span style="color:#75715e"></span>            Serial.print(<span style="color:#e6db74">&#34;cipher: &#34;</span>);
            Serial.println(ap[i].cipher);
        }
    }
    delay(<span style="color:#ae81ff">2000</span>);
    WiFi.connect();
    Serial.println(<span style="color:#e6db74">&#34;Starting up...&#34;</span>);
    request.hostname <span style="color:#f92672">=</span> TELEGRAF_HOST;
    request.port <span style="color:#f92672">=</span> TELEGRAF_PORT;
    request.path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/particle&#34;</span>;
    <span style="color:#66d9ef">int</span> tryInit <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
<span style="color:#75715e">// sometimes the BME sensor takes a while to get figured out.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span>bme.begin()) {
        Serial.println(<span style="color:#e6db74">&#34;Could not find a valid BME280 sensor, check wiring!&#34;</span>);
        delay(<span style="color:#ae81ff">3000</span>);
        <span style="color:#66d9ef">if</span>(<span style="color:#f92672">++</span>tryInit <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">9</span>){
            bme_config <span style="color:#f92672">=</span> false;
            <span style="color:#66d9ef">break</span>;
        }
    }
    tryInit <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
<span style="color:#75715e">/* Initialise the sensor */</span>
    <span style="color:#66d9ef">while</span>(<span style="color:#f92672">!</span>tsl.begin()){
        Serial.print(<span style="color:#e6db74">&#34;Ooops, no TSL2561 detected ... Check your wiring or I2C ADDR!&#34;</span>);
        delay(<span style="color:#ae81ff">3000</span>);
        <span style="color:#66d9ef">if</span>(<span style="color:#f92672">++</span>tryInit <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">9</span>){
            tsl_config <span style="color:#f92672">=</span> false;
            <span style="color:#66d9ef">break</span>;
        }
    }
<span style="color:#75715e">/* Setup the sensor gain and integration time */</span>
    <span style="color:#66d9ef">if</span>(tsl_config){
        configureSensor();
    }
    Serial.print(<span style="color:#e6db74">&#34;Device ID: &#34;</span>);
    Serial.println(myID);
<span style="color:#75715e">// get a couple of readings to make sure …
</span><span style="color:#75715e"></span>    getReadings();
    delay(<span style="color:#ae81ff">2000</span>);
    getReadings();
<span style="color:#75715e">/* Display some basic information on this sensor */</span>
    displaySensorDetails();
<span style="color:#75715e">/* We&#39;re ready to go! */</span>
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loop</span>() {
    getReadings();
    <span style="color:#66d9ef">double</span> fTemp <span style="color:#f92672">=</span> temperature <span style="color:#f92672">*</span> <span style="color:#ae81ff">9</span><span style="color:#f92672">/</span><span style="color:#ae81ff">5</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">32</span>;
    Serial.print(<span style="color:#e6db74">&#34;My IP: &#34;</span>);Serial.println(WiFi.localIP());
    <span style="color:#66d9ef">if</span>(myName <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> ){
<span style="color:#75715e">// begin http post remove for particle cloud publish
</span><span style="color:#75715e"></span>        http_header_t headers[] <span style="color:#f92672">=</span> {
          {<span style="color:#e6db74">&#34;Accept&#34;</span>, <span style="color:#e6db74">&#34;*/*&#34;</span>},
          {<span style="color:#e6db74">&#34;User-agent&#34;</span>, <span style="color:#e6db74">&#34;Particle HttpClient&#34;</span>},
          {NULL, NULL}
        };
        time_t time <span style="color:#f92672">=</span> Time.now();
        Time.format(time, TIME_FORMAT_ISO8601_FULL);
        <span style="color:#66d9ef">int</span> rssi <span style="color:#f92672">=</span> WiFi.RSSI();
        String data <span style="color:#f92672">=</span> String<span style="color:#f92672">::</span>format(<span style="color:#e6db74">&#34;{</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">event</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">: </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">iot_sensor</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">, </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">data</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">: { </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">tags</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74"> : {</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">id</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">: </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">%s</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">, </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">location</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">: </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">%s</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">}, </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">values</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">: {</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">RSSI</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">: %d, </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">temp_c</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">: %f, </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">temp_f</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">: %f, </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">humidity</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">: %f, </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">pressure</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">: %f, </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">altitude</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">: %f, </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">broadband</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">: %d, </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">infrared</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">: %d, </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">lux</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">: %d}}, </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">ttl</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">: 60, </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">coreid</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">: </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">%s</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">, </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">name</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">: </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">sensor</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">, </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">measurement</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">: </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">iot_data</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">}&#34;</span>, myID.c_str(), myName.c_str(), rssi, temperature, fTemp, humidity, pressure, altitude, broadband, infrared, lux, myID.c_str());
        request.body <span style="color:#f92672">=</span> data;
        http.post(request, response, headers);
        Serial.print(<span style="color:#e6db74">&#34;Application&gt;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Response status: &#34;</span>);
        Serial.println(response.status);
        Serial.print(<span style="color:#e6db74">&#34;Application&gt;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">HTTP Response Body: &#34;</span>);
        Serial.println(response.body);
<span style="color:#75715e">// end http post.
</span><span style="color:#75715e"></span>        delay(<span style="color:#ae81ff">1000</span>);
    }
}

<span style="color:#75715e">/* Read the sensors */</span>
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">getReadings</span>(){
    <span style="color:#66d9ef">if</span>(bme_config){
        temperature <span style="color:#f92672">=</span> bme.readTemperature();
        pressure <span style="color:#f92672">=</span> bme.readPressure() <span style="color:#f92672">/</span> <span style="color:#ae81ff">100.0F</span>;
        altitude <span style="color:#f92672">=</span> bme.readAltitude(SEALEVELPRESSURE_HPA);
        humidity <span style="color:#f92672">=</span> bme.readHumidity();
    }
    <span style="color:#66d9ef">if</span>(tsl_config){
        sensors_event_t event;
        tsl.getEvent(<span style="color:#f92672">&amp;</span>event);
<span style="color:#75715e">/* Display the results (light is measured in lux) */</span>
        <span style="color:#66d9ef">if</span> (event.light){
            lux <span style="color:#f92672">=</span> event.light;
        } <span style="color:#66d9ef">else</span> {
<span style="color:#75715e">/* If event.light = 0 lux the sensor is probably saturated
</span><span style="color:#75715e">and no reliable data could be generated! */</span>
           lux <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
        }
<span style="color:#75715e">/* Populate broadband and infrared with the latest values */</span>
        tsl.getLuminosity (<span style="color:#f92672">&amp;</span>broadband, <span style="color:#f92672">&amp;</span>infrared);
    }
}

<span style="color:#75715e">// Open a serial terminal and see the device name printed out
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handler</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>topic, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>data) {
    Serial.println(<span style="color:#e6db74">&#34;received &#34;</span> <span style="color:#f92672">+</span> String(topic) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;: &#34;</span> <span style="color:#f92672">+</span> String(data));
    myName <span style="color:#f92672">=</span> String(data);
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">setLoc</span>(String loc){
    myName <span style="color:#f92672">=</span> loc;
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configureSensor</span>(<span style="color:#66d9ef">void</span>) {
<span style="color:#75715e">/* You can also manually set the gain or enable auto-gain support */</span>
<span style="color:#75715e">// tsl.setGain(TSL2561_GAIN_1X); /* No gain ... use in bright light to avoid sensor saturation */
</span><span style="color:#75715e">// tsl.setGain(TSL2561_GAIN_16X); /* 16x gain ... use in low light to boost sensitivity */
</span><span style="color:#75715e"></span>    tsl.enableAutoRange(true); <span style="color:#75715e">/* Auto-gain ... switches automatically between 1x and 16x */</span>

<span style="color:#75715e">/* Changing the integration time gives you better sensor resolution (402ms = 16-bit data) */</span>
    tsl.setIntegrationTime(TSL2561_INTEGRATIONTIME_13MS); <span style="color:#75715e">/* fast but low resolution */</span>
<span style="color:#75715e">// tsl.setIntegrationTime(TSL2561_INTEGRATIONTIME_101MS); /* medium resolution and speed */
</span><span style="color:#75715e">// tsl.setIntegrationTime(TSL2561_INTEGRATIONTIME_402MS); /* 16-bit data but slowest conversions */
</span><span style="color:#75715e"></span>
<span style="color:#75715e">/* Update these values depending on what you&#39;ve set above! */</span>
    Serial.println(<span style="color:#e6db74">&#34;------------------------------------&#34;</span>);
    Serial.print (<span style="color:#e6db74">&#34;Gain: &#34;</span>); Serial.println(<span style="color:#e6db74">&#34;Auto&#34;</span>);
    Serial.print (<span style="color:#e6db74">&#34;Timing: &#34;</span>); Serial.println(<span style="color:#e6db74">&#34;13 ms&#34;</span>);
    Serial.println(<span style="color:#e6db74">&#34;------------------------------------&#34;</span>);
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">displaySensorDetails</span>(<span style="color:#66d9ef">void</span>) {
    <span style="color:#66d9ef">if</span>(tsl_config){
        sensor_t sensor;
        tsl.getSensor(<span style="color:#f92672">&amp;</span>sensor);
        Serial.println(<span style="color:#e6db74">&#34;------------------------------------&#34;</span>);
        Serial.print (<span style="color:#e6db74">&#34;Sensor: &#34;</span>); Serial.println(sensor.name);
        Serial.print (<span style="color:#e6db74">&#34;Driver Ver: &#34;</span>); Serial.println(sensor.version);
        Serial.print (<span style="color:#e6db74">&#34;Unique ID: &#34;</span>); Serial.println(sensor.sensor_id);
        Serial.print (<span style="color:#e6db74">&#34;Max Value: &#34;</span>); Serial.print(sensor.max_value); Serial.println(<span style="color:#e6db74">&#34; lux&#34;</span>);
        Serial.print (<span style="color:#e6db74">&#34;Min Value: &#34;</span>); Serial.print(sensor.min_value); Serial.println(<span style="color:#e6db74">&#34; lux&#34;</span>);
        Serial.print (<span style="color:#e6db74">&#34;Resolution: &#34;</span>); Serial.print(sensor.resolution); Serial.println(<span style="color:#e6db74">&#34; lux&#34;</span>);
        Serial.println(<span style="color:#e6db74">&#34;------------------------------------&#34;</span>);
        Serial.println(<span style="color:#e6db74">&#34;&#34;</span>);
        delay(<span style="color:#ae81ff">500</span>);
    }
}

</code></pre></div><p>Pretty straightforward. Initialize the sensors (and try a few times). If initialization fails, make sure to handle that as well. I used the bee_config and tsl_config booleans for that. Then read sensor data every second, and post it to the InfluxDB server in a JSON object. I’m actually re-using the Particle Plugin for Telegraf that I wrote, just because I could. I actually wrote the <a href="https://docs.particle.io/tutorials/integrations/influxdata/core/#using-influxcloud">docs</a> over at Particle.io for the <a href="https://docs.particle.io/tutorials/integrations/influxdata/core/#using-influxcloud">InfluxDB/Particle integration</a> (because I also wrote the integration, of course) so feel free to take a look at that if you’d like.</p>
<p>I now have a Particle Photon posting temperature (ºC and ºF), atmospheric pressure, humidity, infrared light, visible light, and lux to my edge device every second. Well, I would if I had an edge device built. That’s coming.</p>
<h3 id="the-ble-cosub2sub-sensor-1">The BLE CO<sub>2</sub> Sensor</h3>
<p>As I said earlier, this one was a bit trickier. I could have programmed this with Arduino, and at first I did. But Arduino just isn’t up to the task with this sensor. That’s because the sensor’s I2C occasionally locks up, and when that happens in Arduino-land, you’re pretty much stuck. You have to restart the board. That’s fine, I guess, but when it happens every 30 seconds, it makes data collection rather unreliable. So I used embedded C on mBed instead. There are also two sides to this sensor. One was the actual sensor code that runs on the nRF52DK board. The other was the code to run on the Edge device to connect over bluetooth and get the data. So let’s start with the device-code. First, I had to define a BLE GATT Characteristic for the CO2 value, so I did that:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#ifndef __K30_SERVICE_H__
</span><span style="color:#75715e">#define __K30_SERVICE_H__
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">K30Service</span> {
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">uint16_t</span> K30_SERVICE_UUID <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xA000</span>;
<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">uint16_t</span> K30_VALUE_CHARACTERISTIC_UUID <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xA001</span>;

K30Service(BLEDevice <span style="color:#f92672">&amp;</span>_ble, <span style="color:#66d9ef">float</span> k30Initial) <span style="color:#f92672">:</span>
ble(_ble), k30Value(K30_VALUE_CHARACTERISTIC_UUID, <span style="color:#f92672">&amp;</span>k30Initial, GattCharacteristic<span style="color:#f92672">::</span>BLE_GATT_CHAR_PROPERTIES_NOTIFY) {
  GattCharacteristic <span style="color:#f92672">*</span>charTable[] <span style="color:#f92672">=</span> {<span style="color:#f92672">&amp;</span>k30Value};
  GattService <span style="color:#a6e22e">k30Service</span>(K30Service<span style="color:#f92672">::</span>K30_SERVICE_UUID, charTable, <span style="color:#66d9ef">sizeof</span>(charTable) <span style="color:#f92672">/</span> <span style="color:#66d9ef">sizeof</span>(GattCharacteristic <span style="color:#f92672">*</span>));
  ble.addService(k30Service);
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">updateK30Value</span>(<span style="color:#66d9ef">float</span> newValue) {
  ble.updateCharacteristicValue(k30Value.getValueHandle(), (<span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>newValue, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">float</span>));
}
<span style="color:#66d9ef">private</span><span style="color:#f92672">:</span> BLEDevice <span style="color:#f92672">&amp;</span>ble; ReadOnlyGattCharacteristic k30Value; };

<span style="color:#75715e">#endif
</span></code></pre></div><p>That’s our GATT Service so that whenever we call it, we get the updated CO2 value from the sensor. Now the code to get the sensor data. Remember, this is I2C code in C. I’m going to go through it in sections to make it more clear what I’m doing.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">/**
</span><span style="color:#75715e">  Copyright (c) 2018 David G. Simmons
</span><span style="color:#75715e">  Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
</span><span style="color:#75715e">  you may not use this file except in compliance with the License.
</span><span style="color:#75715e">  http://www.apache.org/licenses/LICENSE-2.0
</span><span style="color:#75715e">**/</span>
<span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;events/mbed_events.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;mbed.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;ble/BLE.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;ble/Gap.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;k30.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;nrf_nvic.h&#34;</span><span style="color:#75715e">
</span></code></pre></div><p>The <code>k30.h</code> is the code above defining the GATT Service. Next, let’s get all the variable, etc. defined.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">DigitalOut <span style="color:#a6e22e">led1</span>(LED1);
DigitalOut <span style="color:#a6e22e">led2</span>(LED2);
DigitalOut <span style="color:#a6e22e">led3</span>(LED3);
DigitalOut <span style="color:#a6e22e">led4</span>(LED4);
<span style="color:#75715e">//I2C i2c(p24 , p25);
</span><span style="color:#75715e">// Standard I2C pins on the nRF52. But you can use any pins you want really.
</span><span style="color:#75715e"></span>I2C <span style="color:#a6e22e">i2c</span>(p26, p27);
<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xD0</span>;
<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> failures <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">char</span> DEVICE_NAME[] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;CO2Sensor&#34;</span>;
<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">uint16_t</span> uuid16_list[] <span style="color:#f92672">=</span> {K30Service<span style="color:#f92672">::</span>K30_SERVICE_UUID};
<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">float</span> co2Level <span style="color:#f92672">=</span> <span style="color:#ae81ff">50.0</span>;
<span style="color:#66d9ef">static</span> K30Service<span style="color:#f92672">*</span> k30ServicePtr;
<span style="color:#66d9ef">static</span> EventQueue <span style="color:#a6e22e">eventQueue</span>(EVENTS_EVENT_SIZE);
</code></pre></div><p>The nRF52DK has 4 service LEDs on board. I wanted them to go around and around in sequence because I could. Oh, and they should also be able to go backwards. Don’t ask how long I spent getting the timing right so it looked nice.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">lightsFwd</span>(){
  led1 <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>led1;
  wait(<span style="color:#ae81ff">.15</span>);
  led2 <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>led2;
  wait(<span style="color:#ae81ff">.15</span>);
  led4 <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>led4;
  wait(<span style="color:#ae81ff">.15</span>);
  led3 <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>led3;
  wait(<span style="color:#ae81ff">.15</span>);
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">lightsRev</span>(){
  led1 <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>led1;
  wait(<span style="color:#ae81ff">.15</span>);
  led3 <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>led3;
  wait(<span style="color:#ae81ff">.15</span>);
  led4 <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>led4;
  wait(<span style="color:#ae81ff">.15</span>);
  led2 <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>led2;
  wait(<span style="color:#ae81ff">.15</span>);
}
</code></pre></div><p>Now we get to the interesting bit: actually reading the sensor! This is pretty straightforward I2C. The SenseAir Docs have all the details like the I2C address, the commands, etc. so that was already done for me. If you’re using Arduino, there’s actually a complete Arduino sketch that has this as well.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">readSensor</span>(){
  <span style="color:#75715e">// register values
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> cmd[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0x22</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x08</span>, <span style="color:#ae81ff">0x2A</span>};
  <span style="color:#66d9ef">int</span> ack <span style="color:#f92672">=</span> i2c.write(addr, cmd, <span style="color:#ae81ff">4</span>);
  wait(<span style="color:#ae81ff">0.5</span>);
  <span style="color:#66d9ef">char</span> readBuff[<span style="color:#ae81ff">4</span>];
  i2c.read(addr, readBuff, <span style="color:#ae81ff">4</span>, false);
  <span style="color:#66d9ef">int</span> high <span style="color:#f92672">=</span> readBuff[<span style="color:#ae81ff">1</span>]; <span style="color:#75715e">//high byte for value is 4th byte in packet in the packet
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> low <span style="color:#f92672">=</span> readBuff[<span style="color:#ae81ff">2</span>]; <span style="color:#75715e">//low byte for value is 5th byte in the packet
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">float</span> CO2 <span style="color:#f92672">=</span> high<span style="color:#f92672">*</span><span style="color:#ae81ff">256</span> <span style="color:#f92672">+</span> low; <span style="color:#75715e">//Combine high byte and low byte with this formula to get value
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> sum <span style="color:#f92672">=</span> readBuff[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">+</span> readBuff[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">+</span> readBuff[<span style="color:#ae81ff">2</span>]; <span style="color:#75715e">//Byte addition utilizes overflow
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (sum <span style="color:#f92672">==</span> readBuff[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">&amp;</span> ack <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
    <span style="color:#75715e">//pc.printf(&#34;CO2 value = %fn&#34;, CO2);
</span><span style="color:#75715e"></span>    k30ServicePtr<span style="color:#f92672">-&gt;</span>updateK30Value(CO2);
    <span style="color:#66d9ef">if</span>(failures <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>){
      failures<span style="color:#f92672">--</span>;
    }
  } <span style="color:#66d9ef">else</span> {
    <span style="color:#75715e">//pc.printf(&#34;** Sensor Failure **n&#34;);
</span><span style="color:#75715e"></span>    failures<span style="color:#f92672">++</span>;
    CO2 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
    k30ServicePtr<span style="color:#f92672">-&gt;</span>updateK30Value(CO2);
    <span style="color:#66d9ef">if</span>(failures <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">5</span>){ <span style="color:#75715e">// Keep track of the number of failures. If more than 5, reboot the board.
</span><span style="color:#75715e"></span>      i2c.stop();
      <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> x <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; x <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">10</span>; x<span style="color:#f92672">++</span>){
        lightsRev();
      }
      NVIC_SystemReset();
    }
  }
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">disconnectionCallback</span>(<span style="color:#66d9ef">const</span> Gap<span style="color:#f92672">::</span>DisconnectionCallbackParams_t <span style="color:#f92672">*</span>params)
{
  <span style="color:#75715e">//pc.printf(&#34;Disconnected!n&#34;);
</span><span style="color:#75715e"></span>  BLE<span style="color:#f92672">::</span>Instance().gap().startAdvertising();
}
</code></pre></div><p>You’ll notice a few things in there. First, the sensor has a checksum byte, and the sensor does, indeed, sometimes fail this test. I keep track of the number of failures in. a row. If I get more than 5 failures in a row, I concluded that the sensor is having trouble, so I reboot the board and start over. After a <strong>long</strong> bit of trial and error, I found that this is a suitable solution.</p>
<p>The rest of this code is pretty standard boilerplate for BLE connections, etc. and indeed mostly came out of the mBed example programs.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">updateSensorValue</span>() {
  lightsFwd();
  readSensor();
  wait(<span style="color:#ae81ff">1.5</span>);
  lightsFwd();
  wait(<span style="color:#ae81ff">1.5</span>);
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">connectionCallback</span>(<span style="color:#66d9ef">const</span> Gap<span style="color:#f92672">::</span>ConnectionCallbackParams_t <span style="color:#f92672">*</span>params) {
  <span style="color:#75715e">// pc.printf(&#34;Connected!n&#34;);
</span><span style="color:#75715e"></span>  BLE<span style="color:#f92672">::</span>Instance().gap().stopAdvertising();
  eventQueue.call(updateSensorValue);
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">sensorCallback</span>(<span style="color:#66d9ef">void</span>) {
  BLE <span style="color:#f92672">&amp;</span>ble <span style="color:#f92672">=</span> BLE<span style="color:#f92672">::</span>Instance();
  <span style="color:#66d9ef">if</span> (ble.gap().getState().connected) {
    eventQueue.call(updateSensorValue);
  } <span style="color:#66d9ef">else</span> {
    lightsFwd();
  }
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onBleInitError</span>(BLE <span style="color:#f92672">&amp;</span>ble, ble_error_t error) {

}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">printMacAddress</span>(){
  Gap<span style="color:#f92672">::</span>AddressType_t addr_type;
  Gap<span style="color:#f92672">::</span>Address_t address;
  BLE<span style="color:#f92672">::</span>Instance().gap().getAddress(<span style="color:#f92672">&amp;</span>addr_type, address);
  <span style="color:#75715e">//pc.printf(&#34;DEVICE MAC ADDRESS: &#34;);
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>; i <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">1</span>; i<span style="color:#f92672">--</span>){
    <span style="color:#75715e">// printf(&#34;%02x:&#34;, address[i]);
</span><span style="color:#75715e"></span>  }
  <span style="color:#75715e">//pc.printf(&#34;%02xrn&#34;, address[0]);
</span><span style="color:#75715e"></span>}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">bleInitComplete</span>(BLE<span style="color:#f92672">::</span>InitializationCompleteCallbackContext <span style="color:#f92672">*</span>params) {
  BLE<span style="color:#f92672">&amp;</span> ble <span style="color:#f92672">=</span> params<span style="color:#f92672">-&gt;</span>ble;
  ble_error_t error <span style="color:#f92672">=</span> params<span style="color:#f92672">-&gt;</span>error;
  <span style="color:#66d9ef">if</span> (error <span style="color:#f92672">!=</span> BLE_ERROR_NONE) {
    onBleInitError(ble, error);
    <span style="color:#66d9ef">return</span>;
  }
  <span style="color:#66d9ef">if</span>(ble.getInstanceID() <span style="color:#f92672">!=</span> BLE<span style="color:#f92672">::</span>DEFAULT_INSTANCE) {
    <span style="color:#66d9ef">return</span>;
  }

  ble.gap().onDisconnection(disconnectionCallback);
  ble.gap().onConnection(connectionCallback);
  k30ServicePtr <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> K30Service(ble, co2Level);

  ble.gap().accumulateAdvertisingPayload(GapAdvertisingData<span style="color:#f92672">::</span>BREDR_NOT_SUPPORTED <span style="color:#f92672">|</span> GapAdvertisingData<span style="color:#f92672">::</span>LE_GENERAL_DISCOVERABLE);
  ble.gap().accumulateAdvertisingPayload(GapAdvertisingData<span style="color:#f92672">::</span>COMPLETE_LIST_16BIT_SERVICE_IDS, (<span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>) uuid16_list, <span style="color:#66d9ef">sizeof</span>(uuid16_list));
  ble.gap().accumulateAdvertisingPayload(GapAdvertisingData<span style="color:#f92672">::</span>COMPLETE_LOCAL_NAME, (<span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>) DEVICE_NAME, <span style="color:#66d9ef">sizeof</span>(DEVICE_NAME));
  ble.gap().setAdvertisingType(GapAdvertisingParams<span style="color:#f92672">::</span>ADV_CONNECTABLE_UNDIRECTED);
  ble.gap().setAdvertisingInterval(<span style="color:#ae81ff">1000</span>);
  ble.gap().startAdvertising();
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">scheduleBleEventsProcessing</span>(BLE<span style="color:#f92672">::</span>OnEventsToProcessCallbackContext<span style="color:#f92672">*</span> context) {
  BLE <span style="color:#f92672">&amp;</span>ble <span style="color:#f92672">=</span> BLE<span style="color:#f92672">::</span>Instance();
  eventQueue.call(Callback<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">void</span>()<span style="color:#f92672">&gt;</span>(<span style="color:#f92672">&amp;</span>ble, <span style="color:#f92672">&amp;</span>BLE<span style="color:#f92672">::</span>processEvents));
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
  eventQueue.call_every(<span style="color:#ae81ff">1000</span>, sensorCallback);
  BLE <span style="color:#f92672">&amp;</span>ble <span style="color:#f92672">=</span> BLE<span style="color:#f92672">::</span>Instance();
  ble.onEventsToProcess(scheduleBleEventsProcessing);
  ble.init(bleInitComplete);
  eventQueue.dispatch_forever();
  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>So that reads the CO2 value from the sensor every (what looks like) second — at least the callback gets called every second. But in that callback I run the lights around, which takes an additional ~3.25 seconds. And there’s a reason for that. If I were to simply read the sensor every second, I would get duplicate results, and a lot more failures. That’s because the sensor itself only updates its registers every 2 seconds or so. And if you try to read while it’s updating them, it hangs. So this was my compromise for sensor reliability. Seems to have been successful.</p>
<p>Now, as I said, I still had to <strong>read</strong> the data via bluetooth from the Edge Device, so I needed to write something to handle that. The most effective way to get to your Bluetooth device from Linux is by using gatttool, but that’s basically a command-line tool. I’m pretty sure that I could have written some more C code to access the BLE device directly, but I decided to write a small program in Go to simply use gatttool to do it. Again, I&rsquo;ll go through this in sections for you.</p>
<p>We start with some standard Go imports and definitions:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
  <span style="color:#e6db74">&#34;os/exec&#34;</span>
  <span style="color:#e6db74">&#34;strings&#34;</span>
  <span style="color:#e6db74">&#34;bufio&#34;</span>
  <span style="color:#e6db74">&#34;fmt&#34;</span>
  <span style="color:#e6db74">&#34;encoding/binary&#34;</span>
  <span style="color:#e6db74">&#34;encoding/hex&#34;</span>
  <span style="color:#e6db74">&#34;log&#34;</span>
  <span style="color:#e6db74">&#34;math&#34;</span>
  <span style="color:#e6db74">&#34;os&#34;</span>
  <span style="color:#e6db74">&#34;bytes&#34;</span>
  <span style="color:#e6db74">&#34;time&#34;</span>
  <span style="color:#e6db74">&#34;strconv&#34;</span>
)

<span style="color:#66d9ef">var</span> (
  <span style="color:#a6e22e">colonByte</span> = []byte(<span style="color:#e6db74">&#34;:&#34;</span>)
  <span style="color:#a6e22e">spaceByte</span> = []byte(<span style="color:#e6db74">&#34; &#34;</span>)
)

<span style="color:#66d9ef">var</span> (
  <span style="color:#a6e22e">Trace</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Logger</span>
  <span style="color:#a6e22e">Info</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Logger</span>
  <span style="color:#a6e22e">Warning</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Logger</span>
  <span style="color:#a6e22e">Error</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Logger</span>
)

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">timeout</span> = <span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Float32frombytes</span>(<span style="color:#a6e22e">bytes</span> []<span style="color:#66d9ef">byte</span>) <span style="color:#66d9ef">float32</span> {
  <span style="color:#a6e22e">bits</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">binary</span>.<span style="color:#a6e22e">LittleEndian</span>.<span style="color:#a6e22e">Uint32</span>(<span style="color:#a6e22e">bytes</span>)
  <span style="color:#66d9ef">float</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">math</span>.<span style="color:#a6e22e">Float32frombits</span>(<span style="color:#a6e22e">bits</span>)
  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">float</span>
}
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Float32bytes</span>(<span style="color:#66d9ef">float</span> <span style="color:#66d9ef">float32</span>) []<span style="color:#66d9ef">byte</span> {
  <span style="color:#a6e22e">bits</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">math</span>.<span style="color:#a6e22e">Float32bits</span>(<span style="color:#66d9ef">float</span>)
  <span style="color:#a6e22e">bytes</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">4</span>) <span style="color:#a6e22e">binary</span>.<span style="color:#a6e22e">LittleEndian</span>.<span style="color:#a6e22e">PutUint32</span>(<span style="color:#a6e22e">bytes</span>, <span style="color:#a6e22e">bits</span>)
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">bytes</span>
}
</code></pre></div><p>The only really interesting bits there are the conversion of a bunch of bytes to a Float32. Turns out when you read from gatttool what you get back is an array of raw bytes. Since I was writing a Float to BLE from the device, I have to convert those 4 bytes back to a Float. Thanks to Google, I found a way to do that.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">postResults</span>(<span style="color:#a6e22e">result</span> <span style="color:#66d9ef">string</span>) {
  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">out</span> <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Buffer</span>
  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">stderr</span> <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Buffer</span>
  <span style="color:#a6e22e">cmdProc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">exec</span>.<span style="color:#a6e22e">Command</span>(<span style="color:#e6db74">&#34;/usr/bin/curl&#34;</span>, <span style="color:#e6db74">&#34;-i&#34;</span>, <span style="color:#e6db74">&#34;-XPOST&#34;</span>, <span style="color:#e6db74">&#34;http://localhost:8186/write&#34;</span>, <span style="color:#e6db74">&#34;--data-binary&#34;</span>, <span style="color:#a6e22e">result</span>)
  <span style="color:#a6e22e">cmdProc</span>.<span style="color:#a6e22e">Stdout</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">out</span>
  <span style="color:#a6e22e">cmdProc</span>.<span style="color:#a6e22e">Stderr</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">stderr</span>
  <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cmdProc</span>.<span style="color:#a6e22e">Run</span>()
  <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cmdProc</span>.<span style="color:#a6e22e">Wait</span>()
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#a6e22e">Error</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
    <span style="color:#66d9ef">return</span>
  }
  <span style="color:#a6e22e">Info</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Result: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">String</span>())
}
</code></pre></div><p>Ok, I know, you’re saying WTF?? But yea, I used curl to post the data to the database. It seemed like a good idea at the time. I’ll re-write it using the InfluxDB Go Library someday but I was in a hurry.</p>
<p>This next bit was fun.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">runCommand</span>(<span style="color:#a6e22e">macAddr</span> <span style="color:#66d9ef">string</span>) {
  <span style="color:#a6e22e">input</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> []<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">1</span>)
  <span style="color:#a6e22e">argString</span> <span style="color:#f92672">:=</span> string(<span style="color:#e6db74">&#34;-b &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">macAddr</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; -t random --char-write-req --handle=0x000f --value=0100 --listen&#34;</span>)
  <span style="color:#a6e22e">args</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Fields</span>(<span style="color:#a6e22e">argString</span>)
  <span style="color:#a6e22e">cmdString</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;/usr/local/bin/gatttool&#34;</span>
  <span style="color:#a6e22e">cmd</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">exec</span>.<span style="color:#a6e22e">Command</span>(<span style="color:#a6e22e">cmdString</span>, <span style="color:#a6e22e">args</span><span style="color:#f92672">...</span>)
  <span style="color:#a6e22e">Info</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Running: &#34;</span>, <span style="color:#a6e22e">cmdString</span>, <span style="color:#a6e22e">args</span>)
  <span style="color:#a6e22e">cmdOut</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">StdoutPipe</span>()
  <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Start</span>()
  <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Wait</span>()
  <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cmdOut</span>.<span style="color:#a6e22e">Close</span>()
  <span style="color:#a6e22e">reader</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bufio</span>.<span style="color:#a6e22e">NewReader</span>(<span style="color:#a6e22e">cmdOut</span>)
  <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
    <span style="color:#a6e22e">buff</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">ReadBytes</span>(<span style="color:#e6db74">&#39;n&#39;</span>)
    <span style="color:#a6e22e">Trace</span>.<span style="color:#a6e22e">Println</span>(string(<span style="color:#a6e22e">buff</span>))
    <span style="color:#a6e22e">input</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">buff</span>
  }()
  <span style="color:#66d9ef">select</span> {
    <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">After</span>(<span style="color:#a6e22e">timeout</span>):
      <span style="color:#a6e22e">Error</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34; GATTTOOL timed out. Sensor nbot on?&#34;</span>)
      <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">Kill</span>()
      <span style="color:#66d9ef">return</span>
    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">input</span>:
      <span style="color:#a6e22e">res</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Split</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">spaceByte</span>);
      <span style="color:#75715e">//fmt.Println(&#34;Length &#34;, len(res))
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span>(len(<span style="color:#a6e22e">res</span>) &lt; <span style="color:#ae81ff">4</span> ) {
        <span style="color:#a6e22e">Error</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Unexpected return from Gatttool&#34;</span>)
        <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">Kill</span>()
        <span style="color:#66d9ef">return</span>
      }
  }
  <span style="color:#66d9ef">for</span> <span style="color:#ae81ff">1</span> &gt; <span style="color:#ae81ff">0</span> {
    <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
      <span style="color:#a6e22e">buff</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">ReadBytes</span>(<span style="color:#e6db74">&#39;n&#39;</span>)
      <span style="color:#a6e22e">Trace</span>.<span style="color:#a6e22e">Println</span>(string(<span style="color:#a6e22e">buff</span>))
      <span style="color:#a6e22e">input</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">buff</span>
    }()
    <span style="color:#66d9ef">select</span> {
      <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">After</span>(<span style="color:#a6e22e">timeout</span>):
        <span style="color:#a6e22e">Warning</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;timed out&#34;</span>)
        <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Process</span>.<span style="color:#a6e22e">Kill</span>()
        <span style="color:#66d9ef">return</span>
      <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">input</span>:
        <span style="color:#a6e22e">Trace</span>.<span style="color:#a6e22e">Println</span>(string(<span style="color:#a6e22e">i</span>))
        <span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Split</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">colonByte</span>)
        <span style="color:#a6e22e">fd</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Fields</span>(<span style="color:#a6e22e">result</span>[<span style="color:#ae81ff">1</span>])
        <span style="color:#a6e22e">reading</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">4</span>)
        <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">x</span> &lt; len(<span style="color:#a6e22e">fd</span>); <span style="color:#a6e22e">x</span><span style="color:#f92672">++</span> {
          <span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">hex</span>.<span style="color:#a6e22e">DecodeString</span>(string(<span style="color:#a6e22e">fd</span>[<span style="color:#a6e22e">x</span>]))
          <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            panic(<span style="color:#a6e22e">err</span>)
          }
          <span style="color:#a6e22e">reading</span>[<span style="color:#a6e22e">x</span>] = <span style="color:#a6e22e">data</span>[<span style="color:#ae81ff">0</span>]
        }
        <span style="color:#66d9ef">float</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Float32frombytes</span>(<span style="color:#a6e22e">reading</span>)
        <span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">float</span> &lt; <span style="color:#ae81ff">1</span>){
          <span style="color:#a6e22e">Info</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Failed Sensor&#34;</span>)
          <span style="color:#66d9ef">continue</span>;
        } <span style="color:#66d9ef">else</span> {
          <span style="color:#a6e22e">st</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;k30_reader,sensor=k30_co2 co2=&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Itoa</span>(int(<span style="color:#66d9ef">float</span>))
          <span style="color:#a6e22e">Trace</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">st</span>)
          <span style="color:#a6e22e">postResults</span>(<span style="color:#a6e22e">st</span>)
        }
    }
  }
}
</code></pre></div><p>Now that looks like a lot, and looks confusing, but here’s what it basically does. You see, it can open GATTTOOL, but if the device on the other end either isn’t there, or has disconnected, then things break. So I have to timeout on the gatttool command and retry if that happens (which, if you remember the sensor code, it’s for sure going to if the sensor locks up). So there’s a whole bunch of checks to make sure that we get connected, that we get a result, and that the result is at least nominally rational before we go and try to post it to the database. Just believe me when I say that a lot of trial and error and failures went into making this robust. And it is robust. It has run flawlessly for over a month now, 24/7, without problems.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">func <span style="color:#a6e22e">Init</span>(){
  file, err :<span style="color:#f92672">=</span> os.OpenFile(<span style="color:#e6db74">&#34;/var/log/blueCO2.log&#34;</span>, os.O_CREATE<span style="color:#f92672">|</span>os.O_WRONLY<span style="color:#f92672">|</span>os.O_APPEND, <span style="color:#ae81ff">0666</span>)
  <span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> nil {
    fmt.Println(<span style="color:#e6db74">&#34;Failed to open log file&#34;</span>, err)
  }
  Trace <span style="color:#f92672">=</span> log.New(file,<span style="color:#e6db74">&#34;TRACE: &#34;</span>, log.Ldate<span style="color:#f92672">|</span>log.Ltime<span style="color:#f92672">|</span>log.Lshortfile)
  Info <span style="color:#f92672">=</span> log.New(file, <span style="color:#e6db74">&#34;INFO: &#34;</span>, log.Ldate<span style="color:#f92672">|</span>log.Ltime<span style="color:#f92672">|</span>log.Lshortfile)
  Warning <span style="color:#f92672">=</span> log.New(file, <span style="color:#e6db74">&#34;WARNING: “, log.Ldate|log.Ltime|log.Lshortfile)</span>
  Error <span style="color:#f92672">=</span> log.New(file, <span style="color:#e6db74">&#34;ERROR: “, log.Ldate|log.Ltime|log.Lshortfile)</span>
}
func <span style="color:#a6e22e">main</span>() {
  Init()
  myArgs :<span style="color:#f92672">=</span> os.Args[<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>]
  macAddr :<span style="color:#f92672">=</span> myArgs[<span style="color:#ae81ff">0</span>]
  <span style="color:#66d9ef">if</span>(len(myArgs) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1</span>){
    Error.Println(<span style="color:#e6db74">&#34;No BLE Device Address Suplied, Exiting.&#34;</span>)
    <span style="color:#66d9ef">return</span>
  }
  <span style="color:#66d9ef">for</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span> {
    runCommand(macAddr)
  }
}
</code></pre></div><p>Again, fairly straightforward. Just set up some logging functionality, and then run forever. Obviously you have to pass the program the MAC address of the BLE device you want to connect to, but that’s the only thing you need.</p>
<p>So that’s the CO2 sensor, both from the sensor side and from the Edge Device side. <em><strong>whew</strong></em></p>
<h3 id="the-lora-sensors">The LoRA  Sensors</h3>
<p>These are actually two separate sensors, as you know, but I’m going to save us all a little bit of time by combining them since they share a ton of code. Once again, I’ll go through the code in pieces to make it easier. The Radiation Sensor came with a nice little Arduino Library, so Just used that.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ESP8266WiFi.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;RadiationWatch.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;SPI.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;RH_RF95.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;Wire.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// for WEMOs D1 Mini
</span><span style="color:#75715e"></span><span style="color:#75715e">#define RFM95_CS D0
</span><span style="color:#75715e">#define RFM95_INT D8
</span><span style="color:#75715e">#define RFM95_RST D3
</span><span style="color:#75715e"></span><span style="color:#75715e">// Where to send packets to!
</span><span style="color:#75715e"></span><span style="color:#75715e">#define DEST_ADDRESS 1
</span><span style="color:#75715e"></span><span style="color:#75715e">// change addresses for each client board, any number :)
</span><span style="color:#75715e"></span><span style="color:#75715e">#define MY_ADDRESS 2
</span><span style="color:#75715e"></span><span style="color:#75715e">// Wemos D1 Mini pins
</span><span style="color:#75715e"></span>RadiationWatch <span style="color:#a6e22e">radiationWatch</span>(D1, D2);

<span style="color:#75715e">// Change to 434.0 or other frequency, must match RX&#39;s freq!
</span><span style="color:#75715e"></span><span style="color:#75715e">#define RF95_FREQ 434.0
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// Blinky on send
</span><span style="color:#75715e"></span><span style="color:#75715e">#define STATUS_LED D4
</span><span style="color:#75715e"></span><span style="color:#75715e">// Singleton instance of the radio driver
</span><span style="color:#75715e"></span>RH_RF95 <span style="color:#a6e22e">rf95</span>(RFM95_CS, RFM95_INT);
<span style="color:#66d9ef">int16_t</span> packetnum <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// packet counter, we increment per xmission
</span></code></pre></div><p>That’s the defines for the Radiation sensor. Now here’s the stuff for the Melexis Temperature sensor (again, there’s an Arduino Library out there which made it easy).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ESP8266WiFi.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;Adafruit_MLX90614.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;SPI.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;RH_RF95.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;Wire.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// for WEMOs D1 Mini
</span><span style="color:#75715e"></span><span style="color:#75715e">#define RFM95_CS D0
</span><span style="color:#75715e">#define RFM95_INT D8
</span><span style="color:#75715e">#define RFM95_RST D3
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#define GREEN_LED D4
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// Change to 434.0 or other frequency, must match RX&#39;s freq!
</span><span style="color:#75715e"></span><span style="color:#75715e">#define RF95_FREQ 434.0
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// Blinky on send
</span><span style="color:#75715e"></span><span style="color:#75715e">#define LED LED_BUILTIN
</span><span style="color:#75715e"></span><span style="color:#75715e">// Where to send packets to!
</span><span style="color:#75715e"></span><span style="color:#75715e">#define DEST_ADDRESS 1
</span><span style="color:#75715e"></span><span style="color:#75715e">// change addresses for each client board, any number :)
</span><span style="color:#75715e"></span><span style="color:#75715e">#define MY_ADDRESS 3
</span><span style="color:#75715e"></span><span style="color:#75715e">// Singleton instance of the radio driver
</span><span style="color:#75715e"></span>RH_RF95 <span style="color:#a6e22e">rf95</span>(RFM95_CS, RFM95_INT);
<span style="color:#75715e">// for the sensor
</span><span style="color:#75715e"></span>Adafruit_MLX90614 mlx <span style="color:#f92672">=</span> Adafruit_MLX90614();
</code></pre></div><p>Then they both do the same setup function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setup</span>() {
  pinMode(STATUS_LED, OUTPUT);
  Serial.begin(<span style="color:#ae81ff">115200</span>);
  <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span>Serial) {
    delay(<span style="color:#ae81ff">1</span>);
  }
  <span style="color:#75715e">// we&#39;re not using the Wemos WiFi.
</span><span style="color:#75715e"></span>  WiFi.mode(WIFI_OFF);
  delay(<span style="color:#ae81ff">1000</span>);
  pinMode(RFM95_RST, OUTPUT);
  delay(<span style="color:#ae81ff">500</span>);
  digitalWrite(RFM95_RST, HIGH);
  delay(<span style="color:#ae81ff">500</span>);
  Serial.println(<span style="color:#e6db74">&#34;LoRa Radiation TX!&#34;</span>);
  <span style="color:#75715e">// manual reset
</span><span style="color:#75715e"></span>  digitalWrite(RFM95_RST, LOW);
  delay(<span style="color:#ae81ff">100</span>);
  digitalWrite(RFM95_RST, HIGH);
  delay(<span style="color:#ae81ff">100</span>);

  <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span>rf95.init()) {
    Serial.println(<span style="color:#e6db74">&#34;LoRa radio init failed&#34;</span>);
    <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>);
  }
  Serial.println(<span style="color:#e6db74">&#34;LoRa radio init OK!&#34;</span>); <span style="color:#75715e">// Defaults after init are 434.0MHz, modulation GFSK_Rb250Fd250, +13dbM
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>rf95.setFrequency(RF95_FREQ)) {
    Serial.println(<span style="color:#e6db74">&#34;setFrequency failed&#34;</span>);
    <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>);
  }
  Serial.print(<span style="color:#e6db74">&#34;Set Freq to: &#34;</span>); Serial.println(RF95_FREQ);
  <span style="color:#75715e">// Defaults after init are 434.0MHz, 13dBm, Bw = 125 kHz, Cr = 4/5, Sf = 128chips/symbol, CRC on
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// The default transmitter power is 13dBm, using PA_BOOST.
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// If you are using RFM95/96/97/98 modules which uses the PA_BOOST transmitter pin, then
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// you can set transmitter powers from 5 to 23 dBm:
</span><span style="color:#75715e"></span>  rf95.setTxPower(<span style="color:#ae81ff">23</span>, false);
  Serial.println(<span style="color:#e6db74">&#34;Starting sensor ... &#34;</span>);
}
</code></pre></div><p>The Radiation sensor has to register some callbacks, and define those callbacks:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">radiationWatch.setup();
<span style="color:#75715e">// Register the callbacks.
</span><span style="color:#75715e"></span>radiationWatch.registerRadiationCallback(<span style="color:#f92672">&amp;</span>onRadiation);
radiationWatch.registerNoiseCallback(<span style="color:#f92672">&amp;</span>onNoise);
Serial.println(<span style="color:#e6db74">&#34;Callbacks Registered.&#34;</span>);
digitalWrite(STATUS_LED, LOW);

<span style="color:#75715e">// it’s a sensitive little bugger
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onNoise</span>() {
  Serial.println(<span style="color:#e6db74">&#34;Argh, noise, please stop moving&#34;</span>);
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onRadiation</span>() {
  digitalWrite(STATUS_LED, HIGH);
  Serial.println(<span style="color:#e6db74">&#34;Reading Radiation...&#34;</span>);
  <span style="color:#66d9ef">char</span> buf[RH_RF95_MAX_MESSAGE_LEN];
  <span style="color:#66d9ef">uint8_t</span> len <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(buf);
  Serial.println(<span style="color:#e6db74">&#34;A wild gamma ray appeared&#34;</span>);
  <span style="color:#66d9ef">double</span> rad <span style="color:#f92672">=</span> radiationWatch.uSvh();
  <span style="color:#66d9ef">double</span> var <span style="color:#f92672">=</span> radiationWatch.uSvhError();
  <span style="color:#66d9ef">double</span> dose <span style="color:#f92672">=</span> radiationWatch.cpm();
  <span style="color:#66d9ef">double</span> er <span style="color:#f92672">=</span> radiationWatch.uSvh();
  <span style="color:#66d9ef">double</span> coef <span style="color:#f92672">=</span> radiationWatch.uSvhError();
  Serial.print(<span style="color:#e6db74">&#34; Dose: &#34;</span>); Serial.println(dose);
  Serial.print(rad);
  Serial.print(<span style="color:#e6db74">&#34; uSv/h +/- &#34;</span>);
  Serial.println(var);
  <span style="color:#75715e">// Message format is &#34;R,gamma_ray_strength,dose&#34; because the receiver is ALSO getting
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// data from a temp sensor. Could also send the variation, error and error coefficient.
</span><span style="color:#75715e"></span>  sprintf(buf, <span style="color:#e6db74">&#34;%s,%s,%s&#34;</span>, <span style="color:#e6db74">&#34;R&#34;</span>, String(rad).c_str(), String(dose).c_str());
  sendMessage(buf, len);
  digitalWrite(STATUS_LED, LOW);
}
</code></pre></div><p>I defined my own message format because I had to differentiate between the two sensors, and I still had to keep the message size very small to keep the radio board from breaking it up into separate packets.</p>
<p>Initializing the Melexis sensor was a single call to</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">mlx.begin()
</code></pre></div><p>It then just loops forever reading and sending data:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">double</span> ambTempC <span style="color:#f92672">=</span> mlx.readAmbientTempC();
<span style="color:#66d9ef">double</span> objTempC <span style="color:#f92672">=</span> mlx.readObjectTempC();

<span style="color:#75715e">// Message format is &#34;T,AmbientTemp,ObjectTemp&#34; because the receiver is ALSO getting
</span><span style="color:#75715e">// data from a radiation sensor.
</span><span style="color:#75715e"></span>Serial.print(<span style="color:#e6db74">&#34;Amb: &#34;</span>); Serial.print(ambTempC);
Serial.print(<span style="color:#e6db74">&#34; Obj: &#34;</span> ); Serial.println(objTempC);
sprintf(buf, <span style="color:#e6db74">&#34;%s,%s,%s&#34;</span>, <span style="color:#e6db74">&#34;T&#34;</span>, String(ambTempC).c_str(), String(objTempC).c_str());
digitalWrite(LED, HIGH);
digitalWrite(GREEN_LED, HIGH);
</code></pre></div><p>Both sensors have the exact same message sending/reply functions:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">sendMessage</span>(<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> buf, <span style="color:#66d9ef">uint8_t</span> len) {
  Serial.println(<span style="color:#e6db74">&#34;Transmitting...&#34;</span>); <span style="color:#75715e">// Send a message to rf95_server
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> radiopacket[<span style="color:#ae81ff">20</span>];
  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> x <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; x <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">20</span>; x<span style="color:#f92672">++</span>) {
    <span style="color:#66d9ef">if</span> (x <span style="color:#f92672">==</span> len <span style="color:#f92672">||</span> x <span style="color:#f92672">&gt;</span> len) {
      radiopacket[x] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0&#39;</span>;
    }
    radiopacket[x] <span style="color:#f92672">=</span> buf[x];
  }
  itoa(packetnum<span style="color:#f92672">++</span>, radiopacket <span style="color:#f92672">+</span> <span style="color:#ae81ff">13</span>, <span style="color:#ae81ff">10</span>);
  Serial.print(<span style="color:#e6db74">&#34;Sending &#34;</span>); Serial.println(radiopacket);
  radiopacket[<span style="color:#ae81ff">19</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  Serial.println(<span style="color:#e6db74">&#34;Sending...&#34;</span>);
  delay(<span style="color:#ae81ff">10</span>);
  rf95.send((<span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>)radiopacket, <span style="color:#ae81ff">20</span>);
  Serial.println(<span style="color:#e6db74">&#34;Waiting for packet to complete...&#34;</span>);
  delay(<span style="color:#ae81ff">10</span>);
  rf95.waitPacketSent();
  <span style="color:#75715e">// Now wait for a reply
</span><span style="color:#75715e"></span>  waitReply();
}
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">waitReply</span>() {
  <span style="color:#66d9ef">uint8_t</span> buf[RH_RF95_MAX_MESSAGE_LEN];
  <span style="color:#66d9ef">uint8_t</span> len <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(buf);
  Serial.println(<span style="color:#e6db74">&#34;Waiting for reply...&#34;</span>);
  <span style="color:#66d9ef">if</span> (rf95.waitAvailableTimeout(<span style="color:#ae81ff">10000</span>)) {
  <span style="color:#75715e">// Should be a reply message for us now
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (rf95.recv(buf, <span style="color:#f92672">&amp;</span>len)) {
      Serial.print(<span style="color:#e6db74">&#34;Got reply: &#34;</span>);
      Serial.println((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)buf);
      Serial.print(<span style="color:#e6db74">&#34;RSSI: &#34;</span>);
      Serial.println(rf95.lastRssi(), DEC);
    }
    <span style="color:#66d9ef">else</span> {
      Serial.println(<span style="color:#e6db74">&#34;Receive failed&#34;</span>);
    }
  } <span style="color:#66d9ef">else</span> {
    Serial.println(<span style="color:#e6db74">&#34;No reply, is there a listener around?&#34;</span>);
  }
}
</code></pre></div><p>Technically I don’t have to wait for a reply, but I do, just for debugging purposes. Now, as you’d expect, there is some similar code that run on the Wemos tucked inside the Edge Collector, and it is really simple, and very similar. It just reads messages from the radio, formats them a bit, and writes them out to the serial port.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;SPI.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;RH_RF95.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ESP8266WiFi.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">// Wemos D1 Mini ...
</span><span style="color:#75715e"></span><span style="color:#75715e">#define RFM95_CS D1
</span><span style="color:#75715e">#define RFM95_IRQ D2
</span><span style="color:#75715e">#define RFM95_RST D3
</span><span style="color:#75715e"></span><span style="color:#75715e">//
</span><span style="color:#75715e">// This is the receiver, so it receives from anyone, others send to this address.
</span><span style="color:#75715e"></span><span style="color:#75715e">#define MY_ADDRESS 1
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// Change to 434.0 or other frequency, must match RX&#39;s freq!
</span><span style="color:#75715e"></span><span style="color:#75715e">#define RF95_FREQ 434.0
</span><span style="color:#75715e"></span><span style="color:#75715e">// Singleton instance of the radio driver
</span><span style="color:#75715e"></span>RH_RF95 <span style="color:#a6e22e">rf95</span>(RFM95_CS, RFM95_IRQ);
<span style="color:#75715e">// Blinky on receipt
</span><span style="color:#75715e"></span><span style="color:#75715e">#define LED LED_BUILTIN
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setup</span>() {
  Serial.begin(<span style="color:#ae81ff">115200</span>)
  <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span>Serial); {
    delay(<span style="color:#ae81ff">1</span>);
  }
  delay(<span style="color:#ae81ff">100</span>);
  <span style="color:#75715e">// we&#39;re not using the Wemos WiFi.
</span><span style="color:#75715e"></span>  WiFi.mode(WIFI_OFF);
  Serial.println(<span style="color:#e6db74">&#34;LoRa RXer!&#34;</span>);
  pinMode(LED, OUTPUT);
  pinMode(RFM95_RST, OUTPUT);
  digitalWrite(RFM95_RST, HIGH);
  <span style="color:#75715e">// manual reset
</span><span style="color:#75715e"></span>  digitalWrite(RFM95_RST, LOW);
  delay(<span style="color:#ae81ff">100</span>);
  digitalWrite(RFM95_RST, HIGH);
  delay(<span style="color:#ae81ff">100</span>);

  <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span>rf95.init()) {
    Serial.println(<span style="color:#e6db74">&#34;LoRa radio init failed&#34;</span>);
    <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>);
  }
  Serial.println(<span style="color:#e6db74">&#34;LoRa radio init OK!&#34;</span>);

  <span style="color:#75715e">// Defaults after init are 434.0MHz, modulation GFSK_Rb250Fd250, +13dbM
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>rf95.setFrequency(RF95_FREQ)) {
    Serial.println(<span style="color:#e6db74">&#34;setFrequency failed&#34;</span>);
    <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>);
  }
  Serial.print(<span style="color:#e6db74">&#34;Set Freq to: &#34;</span>); Serial.println(RF95_FREQ);
  <span style="color:#75715e">// The default transmitter power is 13dBm, using PA_BOOST.
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// If you are using RFM95/96/97/98 modules which uses the PA_BOOST transmitter pin, then
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// you can set transmitter powers from 5 to 23 dBm:
</span><span style="color:#75715e"></span>  rf95.setTxPower(<span style="color:#ae81ff">23</span>, false);
}
</code></pre></div><p>The loop simply waits for a message, and then formats it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loop</span>(){
  <span style="color:#66d9ef">if</span> (rf95.available()) {
  <span style="color:#75715e">// Should be a message for us now
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">uint8_t</span> buf[RH_RF95_MAX_MESSAGE_LEN];
  <span style="color:#66d9ef">uint8_t</span> len <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(buf);
  String msgBuff <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;iot_sensor,recv_from=LoRa &#34;</span>;
  <span style="color:#66d9ef">if</span> (rf95.recv(buf, <span style="color:#f92672">&amp;</span>len)) {
    digitalWrite(LED, HIGH);
    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)buf;
    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>str;
    <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> strAr[<span style="color:#ae81ff">3</span>];
    <span style="color:#66d9ef">int</span> x <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#75715e">// incoming message format: T|R,reading1,reading2
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span> ((str <span style="color:#f92672">=</span> strtok_r(p, <span style="color:#e6db74">&#34;,&#34;</span>, <span style="color:#f92672">&amp;</span>p)) <span style="color:#f92672">!=</span> NULL) {<span style="color:#75715e">// delimiter is the comma
</span><span style="color:#75715e"></span>      strAr[x<span style="color:#f92672">++</span>] <span style="color:#f92672">=</span> str;
    }
    String mType <span style="color:#f92672">=</span> String(strAr[<span style="color:#ae81ff">0</span>]);
    <span style="color:#66d9ef">double</span> reading1 <span style="color:#f92672">=</span> String(strAr[<span style="color:#ae81ff">1</span>]).toFloat();
    <span style="color:#66d9ef">double</span> reading2 <span style="color:#f92672">=</span> String(strAr[<span style="color:#ae81ff">2</span>]).toFloat();
    <span style="color:#66d9ef">if</span> (mType <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;T&#34;</span>) {
      msgBuff <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;AmbTempC=&#34;</span>;
      msgBuff <span style="color:#f92672">+=</span> String(reading1);
      msgBuff <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;,ObjTempC=&#34;</span>;
      msgBuff <span style="color:#f92672">+=</span> String(reading2);
      msgBuff <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;,AmbTempF=&#34;</span>;
      msgBuff <span style="color:#f92672">+=</span> String((reading1 CONTRIBUTING.rst LICENSE MANIFEST.in README.rst THANKS build dist docs output pelican pelican.egg<span style="color:#f92672">-</span>info posts_processed posts_to_process process.sh pyproject.toml requirements samples setup.cfg setup.py tasks.py tox.ini <span style="color:#ae81ff">1.8</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">32</span>);
      msgBuff <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;,ObjTempF=&#34;</span>;
      msgBuff <span style="color:#f92672">+=</span> String((reading2 CONTRIBUTING.rst LICENSE MANIFEST.in README.rst THANKS build dist docs output pelican pelican.egg<span style="color:#f92672">-</span>info posts_processed posts_to_process process.sh pyproject.toml requirements samples setup.cfg setup.py tasks.py tox.ini <span style="color:#ae81ff">1.8</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">32</span>);
    } <span style="color:#66d9ef">else</span> {
      msgBuff <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;gamma_ray=&#34;</span>;
      msgBuff <span style="color:#f92672">+=</span> String(reading1);
      msgBuff <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;,dose=&#34;</span>;
      msgBuff <span style="color:#f92672">+=</span> String(reading2);
    }
    msgBuff <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;,RSSI=&#34;</span>;
    msgBuff <span style="color:#f92672">+=</span> String(rf95.lastRssi());
    msgBuff <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;.0&#34;</span>;
    Serial.println(msgBuff);
    <span style="color:#75715e">// Send a simple reply
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">uint8_t</span> data[] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Roger that!&#34;</span>;
    rf95.send(data, <span style="color:#66d9ef">sizeof</span>(data));
    rf95.waitPacketSent();
    digitalWrite(LED, LOW);
  } <span style="color:#66d9ef">else</span> {
     Serial.println(<span style="color:#e6db74">&#34;Receive failed&#34;</span>);
  }
}

</code></pre></div><p>You’re probably saying “But isn’t all that Serial line chatter going to mess with the database?” and you’d be right, except I wrote some Go code on the Edge Device to read the data from the Serial port and deal with it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
<span style="color:#f92672">import</span> (
  <span style="color:#e6db74">&#34;os/exec&#34;</span>
  <span style="color:#e6db74">&#34;fmt&#34;</span>
  <span style="color:#e6db74">&#34;bufio&#34;</span>
  <span style="color:#e6db74">&#34;syscall&#34;</span>
  <span style="color:#e6db74">&#34;log&#34;</span>
  <span style="color:#e6db74">&#34;os&#34;</span>
  <span style="color:#e6db74">&#34;bytes&#34;</span>
  <span style="color:#e6db74">&#34;time&#34;</span>
  <span style="color:#e6db74">&#34;strings&#34;</span>
)
<span style="color:#66d9ef">var</span> (
  <span style="color:#a6e22e">colonByte</span> = []byte(<span style="color:#e6db74">&#34;:&#34;</span>)
  <span style="color:#a6e22e">spaceByte</span> = []byte(<span style="color:#e6db74">&#34; &#34;</span>)
)

<span style="color:#66d9ef">var</span> (
  <span style="color:#a6e22e">Trace</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Logger</span>
  <span style="color:#a6e22e">Info</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Logger</span>
  <span style="color:#a6e22e">Warning</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Logger</span>
  <span style="color:#a6e22e">Error</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Logger</span>
)

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">timeout</span> = <span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">postResults</span>(<span style="color:#a6e22e">result</span> <span style="color:#66d9ef">string</span>) {
  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">out</span> <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Buffer</span>
  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">stderr</span> <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Buffer</span>
  <span style="color:#a6e22e">cmdProc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">exec</span>.<span style="color:#a6e22e">Command</span>(<span style="color:#e6db74">&#34;/usr/bin/curl&#34;</span>, <span style="color:#e6db74">&#34;-i&#34;</span>, <span style="color:#e6db74">&#34;-XPOST&#34;</span>, <span style="color:#e6db74">&#34;http://localhost:8186/write&#34;</span>, <span style="color:#e6db74">&#34;--data-binary&#34;</span>, <span style="color:#a6e22e">result</span>)
  <span style="color:#a6e22e">cmdProc</span>.<span style="color:#a6e22e">Stdout</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">out</span>
  <span style="color:#a6e22e">cmdProc</span>.<span style="color:#a6e22e">Stderr</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">stderr</span>
  <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cmdProc</span>.<span style="color:#a6e22e">Run</span>()
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#a6e22e">Error</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
    <span style="color:#66d9ef">return</span>
  }
  <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Result: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">String</span>())
}
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">runPort</span>() {
  <span style="color:#a6e22e">tty</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">OpenFile</span>(<span style="color:#e6db74">&#34;/dev/ttyS2&#34;</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_RDWR</span>|<span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">O_NOCTTY</span>, <span style="color:#ae81ff">0</span>)
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;Cannot open tty port: %vn&#34;</span>, <span style="color:#a6e22e">err</span>)
  }
  <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">tty</span>.<span style="color:#a6e22e">Close</span>()
  <span style="color:#66d9ef">for</span> <span style="color:#ae81ff">1</span> &gt; <span style="color:#ae81ff">0</span> {
    <span style="color:#a6e22e">scanner</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bufio</span>.<span style="color:#a6e22e">NewScanner</span>(<span style="color:#a6e22e">tty</span>)
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">scanner</span>.<span style="color:#a6e22e">Scan</span>() {
      <span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">scanner</span>.<span style="color:#a6e22e">Text</span>()
      <span style="color:#a6e22e">startsWith</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">HasPrefix</span>(<span style="color:#a6e22e">result</span>, <span style="color:#e6db74">&#34;iot_sensor&#34;</span>)
      <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">startsWith</span> {
        <span style="color:#a6e22e">postResults</span>(<span style="color:#a6e22e">result</span>)
        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">result</span>)
      }
    }
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">scanner</span>.<span style="color:#a6e22e">Err</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
      <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
    }
  }
}
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Init</span>(){
  <span style="color:#a6e22e">file</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">OpenFile</span>(<span style="color:#e6db74">&#34;/var/log/wemos.log&#34;</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_CREATE</span>|<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_WRONLY</span>|<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_APPEND</span>, <span style="color:#ae81ff">0666</span>)
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Failed to open log file&#34;</span>, <span style="color:#a6e22e">err</span>)
  }
  <span style="color:#a6e22e">Trace</span> = <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">file</span>,
    <span style="color:#e6db74">&#34;TRACE: &#34;</span>,
    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Ldate</span>|<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Ltime</span>|<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Lshortfile</span>)
  <span style="color:#a6e22e">Info</span> = <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">file</span>,
    <span style="color:#e6db74">&#34;INFO: &#34;</span>,
    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Ldate</span>|<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Ltime</span>|<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Lshortfile</span>)
  <span style="color:#a6e22e">Warning</span> = <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">file</span>,
    <span style="color:#e6db74">&#34;WARNING: &#34;</span>,
    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Ldate</span>|<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Ltime</span>|<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Lshortfile</span>)
  <span style="color:#a6e22e">Error</span> = <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">file</span>,
    <span style="color:#e6db74">&#34;ERROR: &#34;</span>,
    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Ldate</span>|<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Ltime</span>|<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Lshortfile</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
  <span style="color:#a6e22e">Init</span>()
  <span style="color:#66d9ef">for</span> <span style="color:#ae81ff">1</span>&gt;<span style="color:#ae81ff">0</span> {
    <span style="color:#a6e22e">runPort</span>()
  }
}
</code></pre></div><p>And yes, there’s probably a better way, but I already had the code from the <em>other</em> sensor and I was again in a hurry. So there you have it.</p>
<p>And that’s all the sensor code! You should now be able to build all the sensors that I built and have them run the same. But what you <em><strong>really</strong></em> came here for was the Edge Collection device! I know, that’s why I saved it until last. So let’s get to that!</p>
<h3 id="edge-collection-device">Edge Collection Device</h3>
<p>So, you’ve spent the $100 or so for all the parts for the Edge Collection device, and now you’re wondering how to actually <strong>build</strong> it. Welcome to the club! So was I. As it turns out — and Pine-64 doesn’t tell you this up front — but there is actually fairly limited support for the Touchscreen display. The one that they sell. Right. Apparently it works great with Android, but that really didn’t help me much. The version of Linux you pretty much <em>have</em> to use is called <a href="https://www.armbian.com">Armbian</a>. Right, I’d never heard of it either. Before just diving in and installing it, I <strong>strongly</strong> suggest that you read and understand everything <a href="https://www.armbian.com/pine64/">here</a>. Really. I didn’t, and it was a fairly painful experience. That’s also because things like the Touchscreen driver wasn’t in the mainline then, which it is now.</p>
<p>Next thing was, of course, to get <a href="https://www.influxdata.com">InfluxDB</a> and the rest of the <a href="https://www.influxdata.com/time-series-platform/">TICK stack</a> installed. Luckily that is super easy — of course. Here’s the fastest and easiest way to do that:</p>
<pre><code>curl -sL https://repos.influxdata.com/influxdb.key | sudo apt-key add -
source /etc/lsb-release
echo &quot;deb https://repos.influxdata.com/${DISTRIB_ID,,} ${DISTRIB_CODENAME} stable&quot; | sudo tee /etc/apt/sources.list.d/influxdb.list
</code></pre><p>That will add the following line to your sources.list.d/influxdb.list file:</p>
<pre><code>deb https://repos.influxdata.com/ubuntu xenial stable
</code></pre><p>Which is what you want. Then run:</p>
<pre><code>$ sudo apt-get update
$ sudo apt-get install influxdb chronograf telegraf kapacitor
</code></pre><p>and you’re all set! Now, all you have to do is make sure that the code for each of the sensors above is properly installed, and … you’re almost there.</p>
<p>You’ll want to install the Mosquito MQTT broker from Eclipse IoT, but luckily that’s as simple as apt-get install mosquito and you’re good to go.</p>
<p>Remember that I said you should read <strong>all</strong> of the Armbian docs? Right, if you did, then you’ll know that Bluetooth doesn’t actually work out of the box. So here’s how I solved that. I created a script, called ‘ble.sh’:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e">#! /bin/sh
</span><span style="color:#75715e"></span>
/usr/sbin/rfkill list
/usr/local/bin/rtk_hciattach -n -s <span style="color:#ae81ff">115200</span> /dev/ttyS1 rtk_h5
/bin/hciconfig hci0 up
</code></pre></div><p>That will get the ble device setup done. But it has to be run every time your device reboots, so I created a SystemV service control for it</p>
<pre><code>/lib/systemd/system/bluetooth-device.service
[Unit]
Description=Bring the BLE device online, if possible
After=network-online.target

[Service]
ExecStart=/bin/sh /usr/local/bin/ble.sh
Restart=on-failure

[Install]
WantedBy=multi-user.target
</code></pre><p>Now it gets run every time the device reboots and only after the network is up.</p>
<p>I actually wanted the whole box to be basically automatic, so I did a lot of other stuff as system services, like the Bluetooth reader Go script, the Serial Port Go script, etc. Those all start automatically at boot time as well, just so that there is basically zero user-intervention needed. I built this as a data appliance, so zero-configuration was a goal, and a feature.</p>
<p>If you bought the WiFi/BLE adapter — which you really should have — then you get 2 WiFi interfaces. I set one of them up as a private access point for local WiFi sensors and the other I left to join another WiFi network for data upload. Armbian comes with it’s own hostapd installed, so you can just use that to set up the Access Point. Use the wlan1 interface for the AP.</p>
<p>So now you have a box that has all the right parts, and <strong>should</strong> be able to have any and all of the sensors described above connect and log data. Here’s what the dashboard on mine looks like:</p>
<p><img src="/posts/category/iot/iot-hardware/images/SafariScreenSnapz037.png" alt="SafariScreenSnapz037"></p>
<p>Pretty snappy! Now, there are a couple of dashboard elements on there that you won’t be able to get — at least out of the box. Those are the RSSI monitors and the battery monitor. That’s because those aren’t part of telegraf (yet). I wrote those collectors myself. You can get those from my GitHub fork of Telegraf <a href="https://github.com/davidgs/telegraf/tree/iotEdge">here</a>. It’s in the ‘IoTEdge’ branch. Just build that, and update your telegraf.conf file with the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">[[<span style="color:#ae81ff">inputs.linux_battery]]</span>
<span style="color:#75715e"># ## command for reading. If empty default path will be used:</span>
<span style="color:#75715e"># ## This can also be overridden with env variable, see README.</span>
<span style="color:#ae81ff">battstatus = &#34;/sys/class/power_supply/battery/status&#34;</span>
<span style="color:#ae81ff">battvoltage = &#34;/sys/class/power_supply/battery/voltage_now&#34;</span>
<span style="color:#ae81ff">battcurrent = &#34;/sys/class/power_supply/battery/current_now&#34;</span>
<span style="color:#ae81ff">battcapacity = &#34;/sys/class/power_supply/battery/capacity&#34;</span>
<span style="color:#ae81ff">batthealth = &#34;/sys/class/power_supply/battery/health&#34;</span>
</code></pre></div><p>and</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#75715e"># # Collect wireless interface link quality metrics</span>
[[<span style="color:#ae81ff">inputs.linux_wireless]]</span>
<span style="color:#75715e"># ## file path for proc file. If empty default path will be used:</span>
<span style="color:#75715e">## /proc/net/wireless</span>
<span style="color:#75715e"># ## This can also be overridden with env variable, see README.</span>
<span style="color:#ae81ff">proc_net_wireless = &#34;/proc/net/wireless&#34;</span>
<span style="color:#75715e"># ## dump metrics with 0 values too</span>
<span style="color:#75715e"># dump_zeros = true</span>
</code></pre></div><p>That will get you the stats on the battery/power and on any and all wireless interfaces installed. If you want to save yourself a ton of work, and want a dashboard that looks <strong>exactly</strong> like mine you’re in for a real treat. With the new Chronograf (v1.6) you can simply save <a href="https://davidgs.com/IoTEdge-3.json">this</a>, and then import it and have an exact copy!</p>
<p>Ok, we’re almost there! The last thing was that I wanted this, as I said, to be ‘automatic’ so I didn’t want anyone to have to login, or launch the dashboard, etc. So first, I had to get rid of the login bit.</p>
<p>I installed ‘nodm’ as the default manager, which bypasses the login screen on boot up. That’s fairly simple. But now to make sure that the dashboard always comes up by default, at full-screen so there’s very little room for end-user shenanigan. You need to create a startup item for Chromium Browser:</p>
<pre><code>demokit-2:/home/demo/.config# cat autostart/dashboard.desktop
[Desktop Entry]
Encoding=UTF-8
Version=0.9.4
Type=Application
Name=Chronograf Dashboard
Comment=dashboard
Exec=chromium-browser --incognito --kiosk http://localhost:8888/sources/1/dashboards/1#
OnlyShowIn=XFCE;
StartupNotify=false
Terminal=false
Hidden=false
</code></pre><p>I created a user ‘demo’ that has <strong>very</strong> limited permissions, and put this file in their .config/autostart directory. That kicks off Chrome browser, pointed directly at the dashboard, with no window decorations, so the user can’t exit the browser and have access to the user desktop. The only drawback to this is that you have to have an alternative method of logging in and controlling/configuring things. For that, I installed TightVNC — and enabled it under a <strong>different</strong> user I created. So there’s a ‘setup’ user that can login with TightVNC to do things like change the WiFi setup, etc. but the ‘demo’ user always gets the pre-defined dashboard.</p>
<h2 id="conclusion">Conclusion</h2>
<p>That should be a great start on building this whole setup. I will admit that Armbian can be a bit fiddly and takes a fair amount of TLC to get it setup correctly. Getting the WiFi AP working, and connecting the <strong>other</strong> WiFi interface to an upstream internet connection is tough. The upstream WiFi has a nasty habit of just dropping off, or losing its default route, etc.</p>
<p>I have probably forgotten a bunch of little tweaks I made here and there to make things work smoothly, and where I have omitted things, I apologize. I undertook this project over the course of several months and am constantly making small improvements. It has been difficult to keep track of all the small changes made. If you find anything that is inaccurate, or needs updating, please contact me and let me know!</p>
<p>And finally, if you build one of these, I’d love to hear about it! Let me know what you built, and how you’re using it!</p>

        
        

        
        
        
        


        


        
        
        
        
        
        
          
        
        
        </div>

        
        
          <div class="btn-improve-page">
              <a href="https://github.com/davidgs/website/edit//content/posts/category/iot/iot-hardware/building-an-influxdb-iot-edge-data-collection-device.md">
                <i class="fas fa-code-branch"></i>
                Improve this page
              </a>
          </div>
        

        
      <hr />
        <div class="row next-prev-navigator">


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
      
      <div class="col-md-6 previous-article">
        <a href="/posts/category/programming/adventures-in-golang/" class="btn btn-outline-info">
          <span><i class="fas fa-chevron-circle-left"></i> Prev</span>
          <br />
          <span>Adventures in Golang</span>
        </a>
      </div>
      
    
    
      
        
        
          
              
          
        
        <div class="col-md-6 next-article">
          <a href="/posts/category/iot/iot-software/programming-the-artik-0-iot-devices/" class="btn btn-outline-info">
            <span>Next <i class="fas fa-chevron-circle-right"></i></span>
            <br />
            <span>Programming the ARTIK-0 IoT Devices</span>
          </a>
        </div>
      
    
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

</div>

      <hr />
      
      
      </div>
    </div>
  </div>
  
</section>


      
      
  <section class="toc-section" id="toc-section">
    
    <div class="toc-holder">
      <h5 class="text-center pl-3">Table of Contents</h5>
      <hr>
      <div class="toc">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#the-hardware">The Hardware</a>
      <ul>
        <li><a href="#the-wifi-sensor">The WiFi Sensor</a></li>
        <li><a href="#the-ble-cosub2sub-sensor">The BLE CO<sub>2</sub> Sensor</a></li>
        <li><a href="#the-lora-radiation-sensor">The LoRa Radiation Sensor</a></li>
        <li><a href="#the-contactless-temperature-sensor">The Contactless Temperature Sensor</a></li>
      </ul>
    </li>
    <li><a href="#building-the-edge-collector">Building the Edge Collector</a></li>
    <li><a href="#the-software">The Software</a>
      <ul>
        <li><a href="#the-wifi-sensor-1">The WiFi Sensor</a></li>
        <li><a href="#the-ble-cosub2sub-sensor-1">The BLE CO<sub>2</sub> Sensor</a></li>
        <li><a href="#the-lora-sensors">The LoRA  Sensors</a></li>
        <li><a href="#edge-collection-device">Edge Collection Device</a></li>
      </ul>
    </li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav>
      </div>
    </div>
    
  </section>

    </div>

    

  




  




  
  
    
  









  







<footer class="container-fluid text-center align-content-center footer pb-2">
  <div class="container pt-5">
    <div class="row text-left">
      <div class="col-md-4 col-sm-12">
        <h5>Navigation</h5>
        
        <ul>
            
              
              
                
              
              <li class="nav-item">
                <a class="smooth-scroll" href="#about">About</a>
              </li>
            
            
              
              
                
              
              <li class="nav-item">
                <a class="smooth-scroll" href="#skills">Skills</a>
              </li>
            
            
              
              
                
              
              <li class="nav-item">
                <a class="smooth-scroll" href="#experiences">Experience</a>
              </li>
            
            
              
              
                
              
              <li class="nav-item">
                <a class="smooth-scroll" href="#education">Education</a>
              </li>
            
            
              
              
                
              
              <li class="nav-item">
                <a class="smooth-scroll" href="#projects">Projects</a>
              </li>
            
            
              
              
                
              
              <li class="nav-item">
                <a class="smooth-scroll" href="#recent-posts">Recent Posts</a>
              </li>
            
        </ul>
        

      </div>
      
      <div class="col-md-4 col-sm-12">
        <h5>Contact me:</h5>
        <ul>
          
          <li><span>Email: </span> <span>davidgs@davidgs.com</span></li>
          
          <li><span>Phone: </span> <span>&#43;1 (919) 534-5099</span></li>
          
        </ul>
      </div>
      
      
      <div class="col-md-4 col-sm-12">
        
        <p>Stay up to date with email notification</p>
        <form>
          <div class="form-group">
            <input
              type="email"
              class="form-control"
              id="exampleInputEmail1"
              aria-describedby="emailHelp"
              placeholder="Enter email"
            />
            <small id="emailHelp" class="form-text text-muted"
              >We&#39;ll never share your email with anyone else.</small
            >
          </div>
          <button type="submit" class="btn btn-info">Submit</button>
        </form>
      </div>
      
    </div>
  </div>
  <hr />
  <div class="container">
    <div class="row text-left">
      <div class="col-md-4">
        <a id="theme" href="https://github.com/hossainemruz/toha" target="#">
          <img src="/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_2.png">
          Toha
        </a>
      </div>
      <div class="col-md-4 text-center">© 2020 Copyright.</div>
      <div class="col-md-4 text-right">
        <a id="hugo" href="https://gohugo.io/">Powered by
        <img
          src="/images/hugo-logo.svg"
          alt="Hugo Logo"
          height="18"
        />
        </a>
      </div>
    </div>
  </div>
</footer>

    <script src="/js/jquery-3.4.1.min.js"></script>
<script src="/js/popper.min.js"></script>
<script src="/js/bootstrap.min.js"></script>

<script src="/js/navbar.js"></script>
<script src="/js/main.js"></script>


    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>
<script src="/js/single.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>



    
    
<script type="text/javascript">
  var sc_project = 4739013;
  var sc_invisible = 0;
  var sc_security = "3147012e";
  var scJsHost = "https://";
  document.write("<sc" + "ript type='text/javascript' src='" +
    scJsHost +
    "statcounter.com/counter/counter.js'></" + "script>");
</script>
<noscript>
  <div class="statcounter"><a title="Web Analytics
Made Easy - StatCounter" href="https://statcounter.com/" target="_blank"><img class="statcounter"
        src="https://c.statcounter.com/4739013/0/3147012e/0/" alt="Web Analytics Made Easy -
StatCounter"></a></div>
</noscript>

  </body>
</html>
