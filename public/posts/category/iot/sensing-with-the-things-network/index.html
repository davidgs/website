<!DOCTYPE html>
<html>
  <head>
    <style>
      {
          {
           partial "debugprint.css" | safeCSS
        }
      }
    </style>
    <title>Sensing with The Things Network</title>
    




  





  



<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="X-UA-Compatible" content="ie=edge" />


<link rel="stylesheet" href="/css/bootstrap.min.css"/>
<link rel="stylesheet" href="/css/layouts/main.css"/>
<link rel="stylesheet" href="/css/style.css"/>
<link rel="stylesheet" href="/css/navigators/navbar.css"/>


<link href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" />


<link rel="icon" type="image/png" href="/images/site/favicon_hu0b3af3b2695bc2a8e88d59b9721b8a18_8831_42x0_resize_box_2.png" />


<link rel="stylesheet" href="/css/style.css"/>

    
<meta name="description" content="Sensing with The Things Network" />
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css"
/>
<link rel="stylesheet" href="/css/layouts/single.css"/>
<link rel="stylesheet" href="/css/navigators/sidebar.css">


    
    
  </head>

  <body data-spy="scroll" data-target="#TableOfContents" data-offset="80">
    <div class="container-fluid bg-dimmed wrapper">
      
      
    





  



  





  





  



<nav class="navbar navbar-expand-xl top-navbar final-navbar shadow">
  <div class="container">
      <button class="navbar-toggler navbar-light" id="sidebar-toggler" type="button" onclick="toggleSidebar()">
      <span class="navbar-toggler-icon"></span>
    </button>
    <a class="navbar-brand" href="/">
      <img src="/images/site/main-logo_hu36e4c6c516043df4c5aad6d68b952eee_646582_42x0_resize_box_2.png">David G. Simmons</a>
    <button class="navbar-toggler navbar-light" id="toc-toggler" type="button" onclick="toggleTOC()">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse lang-selector" id="top-nav-items">
      <ul class="navbar-nav ml-auto">
      
      </ul>
    </div>
  </div>
  
  <img src="/images/site/main-logo_hu36e4c6c516043df4c5aad6d68b952eee_646582_42x0_resize_box_2.png" class="d-none" id="main-logo">
  <img src="/images/site/inverted-logo_hu527ca2c923a6347a00483834e2e3046d_608569_42x0_resize_box_2.png" class="d-none" id="inverted-logo">
</nav>



      
      
  <section class="sidebar-section" id="sidebar-section">
    <div class="sidebar-holder">
      <div class="sidebar" id="sidebar">
        <input type="text" value="" placeholder="Search" data-search="" id="search-box" />
        <div class="sidebar-tree">
          <ul class="tree" id="tree">
            <li id="list-heading"><a href="/posts" data-filter="all">Posts</a></li>
            <div class="subtree">
                
  
  
  
  
  
    
    <li><a class="" href="/posts/introduction/introduction/">Introduction</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/mad-skillz/mad-skillz/">Mad Skillz</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/beans/beans/">Coffee Beans</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/hobbies/">Hobbies</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/pranks/">Pranks</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/category/camunda/">Camunda</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/category/general/">General</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/category/programming/">Programming</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/category/dogs/">Dogs</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/category/database/">Databases</a></li>
  

  
  
  
  
  
    
    <li>
      <i class="fas fa-plus-circle"></i><a class="" href="/posts/category/iot/">IoT</a>
      
      <ul class="">
        
  
  
  
  
  
    
    <li><a class="" href="/posts/category/iot/iot-hardware/">Hardware</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/category/iot/iot-software/">Software</a></li>
  


      </ul>
    </li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/work/">Work</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/category/devrel/">DevRel</a></li>
  


            </div>
          </ul>
        </div>
      </div>
    </div>
  </section>


      
      
<section class="content-section" id="content-section">
  <div class="content">
    <div class="container p-0 read-area">
      
      
      
        
        
        
        
        






























&#34;https://davidgs.com/posts/category/iot/images/TheThings.jpg&#34;








        <div class="hero-area col-sm-12" id="hero-area" style='background-image: url(https://davidgs.com/posts/category/iot/images/TheThings.jpg);'>
      </div>
      


      
      <div class="page-content">
        <div class="author-profile ml-auto align-self-lg-center">
          <img class="rounded-circle" src='/images/author/dg3.png'/>
          <h5 class="author-name">David G. Simmons</h5>
          <p>October 10, 2019</p>
        </div>

        <div class="title">
          <h1>Sensing with The Things Network</h1>
        </div>

        <div class="post-content" id="post-content">


          <p>There are many ways to connect your sensors to the network in the IoT. For short-range connections, there is Bluetooth LE, or Zigbee, or 802.15.4, or ZWave. For longer distances (though still fairly short) there’s always WiFi. But when you need longer distances, sometimes <strong>very</strong> long distances, there’s LoRaWAN. It’s a sub-gigahertz set of frequencies that are available for small bits of data. These are typically only a few bytes of data but can be sent over much longer distances — up to 2 km or more in some instances! They are very low-power, so they are great for remote-sensing applications.</p>
<p>In order to test out some LoRaWAN data transmission, and see how hard it might be to get that data into InfluxDB, I decided to move one of my sensors, a temperature/humidity/pressure sensor, to The Things Network (TTN), a community-based LoRaWAN provider. I wasn’t sure how hard, or easy, this transition might be, but I was able to complete it in less than a day! So here’s how you can do it too.</p>
<h2 id="the-hardware">The hardware</h2>
<p>First of all, you will need to make sure that either you have a TTN Gateway yourself, or that there is one in your area. As you can see, there are a <em>lot</em> of gateways available.</p>
<p><img src="/posts/category/iot-iot-software/images/Screen-Shot-2019-10-09-at-12.08.22-PM.png" alt=""></p>
<p>There wasn’t one close enough, so I put up my own (Tip: These are <strong>not</strong> cheap to buy — mine cost me &gt;$200) so you can see me on the map now:</p>
<p><img src="/posts/category/iot-iot-software/images/Screen-Shot-2019-10-09-at-12.09.32-PM-1.png" alt=""></p>
<p>There are lots of tutorials on how to set up a gateway, so I’m not going to cover that here.</p>
<p>Next, you’ll need a LoRA radio for your sensor. I happened to have an <a href="https://www.adafruit.com/product/2772">Adafruit Feather M0</a> board lying around (I have a lot of random pieces of hardware just ‘lying around’), so I got an <a href="https://www.adafruit.com/product/3231">Adafruit LorRa Featherwing</a> for it and put it on. Lastly, I used a <a href="https://www.adafruit.com/product/2652">BME280 breakout board</a> (again from Adafruit. They really ought to sponsor me!) to collect the data and I was ready to go.</p>
<p>Wiring everything up takes a minute, so I&rsquo;ll give you the details on how I wired mine. The first thing to note is that with the LoRaWAN Featherwing, you <strong>must</strong> do additional soldering. You can see below how I had to solder jumpers in from <code>IRQ</code>{.language-markup}, <code>CS</code>{.language-markup}, <code>RST</code>{.language-markup}, <code>DIO1</code>{.language-markup} and <code>DIO2</code>{.language-markup}. These then map to pins on the M0 Feather, which we will see in the software section. If you wire these jumpers up differently, you will need to adjust the pin settings in your software accordingly.</p>
<p><img src="/posts/category/iot-iot-software/images/IMG_6122.png" alt=""></p>
<p>You can also see some small red wires coming in from off-screen (I love this ceramic-coated wire, even if it is a pain to solder). Those come from the BME280 Breakout board and go to the I2C pins and the 3v/ground on the board to power the sensor. Once all that is wired up, it&rsquo;s down to software!</p>
<h2 id="the-software">The software</h2>
<p>Software for this took me a minute to get working, but most of that had to do with the difference in <em>how</em> you send data over LoRaWAN. I’m used to using BLE or WiFi, so the size of the data packets really doesn’t matter that much. With LoRaWAN, the size of the data packets reigns supreme.</p>
<p>The first thing you’ll want to do is install the right library for your Arduino. I used the <a href="https://github.com/mcci-catena/arduino-lmic">MCCI LoRaWAN LMIC Library</a>. It seemed the easiest for integrating with TTN. Some of the documentation on this library was a bit less than clear (at least for me) so I&rsquo;ll give you the specifics of what I did to get this running on an M0 Feather. From there, I started with the <code>ttn-otaa-feather-us915</code> sample program. Now, to fill in the pieces. You&rsquo;ll need to go to your TTN Console and create a new Application.</p>
<p><img src="/posts/category/iot-iot-software/images/Screen-Shot-2019-10-09-at-1.19.29-PM.png" alt=""></p>
<p>Once you&rsquo;ve registered that application, you will need to get the Application EUIS (ID) to paste into your Arduino Sketch. It&rsquo;s important to note that, by default, the TTN console gives you your EUIS with most significant bit first (big-endian) whereas the Arduino sketch expects it in little-endian. Luckily, the TTN console makes all of that easy:</p>
<p><img src="/posts/category/iot-iot-software/images/AppEUI.gif" alt=""></p>
<p>As you can see, it even makes copying it into a byte-array simple.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">const</span> u1_t PROGMEM APPEUI[<span style="color:#ae81ff">8</span>] <span style="color:#f92672">=</span> { <span style="color:#ae81ff">0xB2</span>, <span style="color:#ae81ff">0x38</span>, <span style="color:#ae81ff">0x02</span>, <span style="color:#ae81ff">0xD0</span>, <span style="color:#ae81ff">0x7E</span>, <span style="color:#ae81ff">0xD5</span>, <span style="color:#ae81ff">0xB3</span>, <span style="color:#ae81ff">0x70</span> };
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">os_getArtEui</span> (u1_t<span style="color:#f92672">*</span> buf) {
  memcpy_P(buf, APPEUI, <span style="color:#ae81ff">8</span>);
}
</code></pre></div><p>So, that&rsquo;s the APP ID. Next you&rsquo;ll do the same thing for your Device ID and your App Key. Click to register a new device, and you can get access to all the needed information from there:</p>
<p><img src="/posts/category/iot-iot-software/images/Screen-Shot-2019-10-09-at-1.33.14-PM.png" alt=""></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// This should also be in little endian format, see above.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">const</span> u1_t PROGMEM DEVEUI[<span style="color:#ae81ff">8</span>] <span style="color:#f92672">=</span> { <span style="color:#f92672">&lt;</span>insert Dev Key<span style="color:#f92672">&gt;</span> };
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">os_getDevEui</span> (u1_t<span style="color:#f92672">*</span> buf) {
  memcpy_P(buf, DEVEUI, <span style="color:#ae81ff">8</span>);
}

<span style="color:#75715e">// This key should be in big endian format (or, since it is not really a
</span><span style="color:#75715e">// number but a block of memory, endianness does not really apply). In
</span><span style="color:#75715e">// practice, a key taken from the TTN console can be copied as-is.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">const</span> u1_t PROGMEM APPKEY[<span style="color:#ae81ff">16</span>] <span style="color:#f92672">=</span> { <span style="color:#f92672">&lt;</span>insert Program Key<span style="color:#f92672">&gt;</span> };
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">os_getDevKey</span> (u1_t<span style="color:#f92672">*</span> buf) {
  memcpy_P(buf, APPKEY, <span style="color:#ae81ff">16</span>);
}
</code></pre></div><p>And don&rsquo;t worry about me publishing those IDs. I created that dummy application and device just for this blog post, and they are long-gone now. But as a reminder, never publish your IDs or keys like this.</p>
<p>You will need to adjust this data buffer for your data, but here&rsquo;s what I used: <code>unsigned char mydata[11];</code>{.language-markup} Remember, I said that the data transmitted was intentionally kept <em>very</em> low, so I&rsquo;m packing a whole lot of data into this 11 bytes! We&rsquo;ll see how I do that in a bit.</p>
<p>Next comes the pins. Remember from the hardware section? If you wired your LoRaWAN feather exactly like mine, this should work for you.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#if defined(ARDUINO_SAMD_FEATHER_M0) || defined(ADAFRUIT_FEATHER_M0)
</span><span style="color:#75715e"></span><span style="color:#75715e">// Pin mapping for Adafruit Feather M0 LoRa, etc.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> lmic_pinmap lmic_pins <span style="color:#f92672">=</span> {
  .nss <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>,
  .rxtx <span style="color:#f92672">=</span> LMIC_UNUSED_PIN,
  .rst <span style="color:#f92672">=</span> <span style="color:#ae81ff">6</span>,
  .dio <span style="color:#f92672">=</span> {<span style="color:#ae81ff">9</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">11</span>},
  .rxtx_rx_active <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
  .rssi_cal <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>, <span style="color:#75715e">// LBT cal for the Adafruit Feather M0 LoRa, in dB
</span><span style="color:#75715e"></span>  .spi_freq <span style="color:#f92672">=</span> <span style="color:#ae81ff">8000000</span>,
};
</code></pre></div><p>Those were a little hard to figure out, and in the sample code it leaves a couple of those <code>dio</code>{.language-markup} pins as <code>LMIC_UNUSED_PIN</code>{.language-markup} but mine wouldn&rsquo;t work until I defined them all.</p>
<p>For the rest of my code I used some boiler-plate I have for the BME280:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">Adafruit_BME280 bme;
<span style="color:#66d9ef">double</span> temperature <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.00</span>;
<span style="color:#66d9ef">double</span> pressure <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.00</span>;
<span style="color:#66d9ef">double</span> altitude <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.00</span>;
<span style="color:#66d9ef">double</span> humidity <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.00</span>;
<span style="color:#66d9ef">bool</span> bme_config <span style="color:#f92672">=</span> true;

<span style="color:#75715e">// this goes in the setup() function:
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> tryInit <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
<span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span>bme.begin()) {
  Serial.println(<span style="color:#e6db74">&#34;Could not find a valid BME280 sensor, check wiring!&#34;</span>);
  delay(<span style="color:#ae81ff">3000</span>);
  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">++</span>tryInit <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">9</span>) {
    bme_config <span style="color:#f92672">=</span> false;
    <span style="color:#66d9ef">break</span>;
  }
}

<span style="color:#75715e">// a function to get readings:
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">getReadings</span>() {
  <span style="color:#66d9ef">if</span> (bme_config) {
    temperature <span style="color:#f92672">=</span> bme.readTemperature();
    pressure <span style="color:#f92672">=</span> bme.readPressure() <span style="color:#f92672">/</span> <span style="color:#ae81ff">100.0F</span>;
    altitude <span style="color:#f92672">=</span> bme.readAltitude(SEALEVELPRESSURE_HPA);
    humidity <span style="color:#f92672">=</span> bme.readHumidity();
    Serial.print(<span style="color:#e6db74">&#34;Temp: &#34;</span>); Serial.println(temperature);
    Serial.print(<span style="color:#e6db74">&#34;Humidity: &#34;</span>); Serial.println(humidity);
    Serial.print(<span style="color:#e6db74">&#34;Pressure: &#34;</span>); Serial.println(pressure);
    Serial.print(<span style="color:#e6db74">&#34;Altitude: &#34;</span>); Serial.println(altitude);
  }
}
</code></pre></div><p>Now, to get the data stuffed into 11 bytes! You&rsquo;ll notice that in my boilerplate BME280 code I defined all the measurements as <code>double</code>{.language-markup} which was fine for high-bandwidth applications, but it just won&rsquo;t do for LoRaWAN. So I&rsquo;m going to whittle them down to 2-bytes each (except the pressure measurement, which will stay at 4-bytes).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">getReadings();
<span style="color:#66d9ef">uint16_t</span> ft <span style="color:#f92672">=</span> (<span style="color:#66d9ef">uint16_t</span>)(temperature <span style="color:#f92672">*</span> <span style="color:#ae81ff">100</span>);
<span style="color:#66d9ef">uint16_t</span> fh <span style="color:#f92672">=</span> (<span style="color:#66d9ef">uint16_t</span>)(humidity <span style="color:#f92672">*</span> <span style="color:#ae81ff">100</span>);
<span style="color:#66d9ef">uint32_t</span> fp <span style="color:#f92672">=</span> (<span style="color:#66d9ef">uint32_t</span>)(pressure <span style="color:#f92672">*</span> <span style="color:#ae81ff">100</span>);
<span style="color:#66d9ef">uint16_t</span> fa <span style="color:#f92672">=</span> (<span style="color:#66d9ef">uint16_t</span>)(altitude <span style="color:#f92672">*</span> <span style="color:#ae81ff">100</span>);
</code></pre></div><p>If I have readings like:</p>
<blockquote>
<p>Temp: 25.04
Humidity: 54.60
Pressure: 1006.38
Altitude: 57.34</p>
</blockquote>
<p>Then I&rsquo;ll end up with</p>
<blockquote>
<p>Temp: 2504
Humidity: 5460
Pressure 100638
Altitude: 5734</p>
</blockquote>
<p>All 16- and 32-bit integers. Now, to stuff them all into my data array:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">mydata[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> ft <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">8</span>;
mydata[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> ft <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>;
mydata[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> fh <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">8</span>;
mydata[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> fh <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>;
mydata[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> fp <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>;
mydata[<span style="color:#ae81ff">5</span>] <span style="color:#f92672">=</span> (fp <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>;
mydata[<span style="color:#ae81ff">6</span>] <span style="color:#f92672">=</span> (fp <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">16</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>;
mydata[<span style="color:#ae81ff">7</span>] <span style="color:#f92672">=</span> (fp <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">24</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>;
mydata[<span style="color:#ae81ff">8</span>] <span style="color:#f92672">=</span> fa <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">8</span>;
mydata[<span style="color:#ae81ff">9</span>] <span style="color:#f92672">=</span> fa <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>;
</code></pre></div><p>If you&rsquo;re not familiar with bit-wise data manipulation, basically I&rsquo;m just moving each byte of each number into a spot in my byte-array. Since the pressure number is a 4-byte value, I have to do extra shifting. I can then send that off to TTN via LoRaWAN and my data transmission is completed.</p>
<p>Sadly though, we&rsquo;re not done yet!. TTN will politely send all the data I send to it out to an MQTT broker for me so that I can subscribe to it and do with it as I please. (<strong>Spoiler alert:</strong> I&rsquo;m going to put it into InfluxDB!)</p>
<h2 id="getting-the-data">Getting the data</h2>
<p>My data is now coming into TTN via LoRaWAN, and is being written out to an MQTT broker for me, but how do I get at it? Well, the first thing to do is subscribe! I use an app called MQTT Box on my Mac to subscribe to various MQTT brokers to see data from different inputs. It allows me to define multiple brokers, and to subscribe to any number of topics from those brokers to see my data. To subscribe to the broker you need 3 pieces of information: The name/address of the broker, the username and the password to connect. For those of us in the US, the address of the broker is <code>us-west.thethings.network</code>{.language-markup} . For your username, you will use the name of your application. In the example above, we&rsquo;d use <code>my-temp-app</code>{.language-markup} as the username. For the password, you&rsquo;ll go to your application on the TTN Console, and look for the <code>Application Key</code>{.language-markup} at the bottom of the page. Copy/paste that in to the password field for the broker and you should connect.</p>
<p>If I look at my data coming out to my MQTT broker, I immediately notice a problem: It&rsquo;s just a random-looking string of characters. It&rsquo;s actually not random at all, it&rsquo;s your data buffer, base-64 encoded.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">{
  <span style="color:#e6db74">&#34;app_id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;my-temp-app&#34;</span>,
  <span style="color:#e6db74">&#34;dev_id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;my-device&#34;</span>,
  <span style="color:#e6db74">&#34;hardware_serial&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;009E9BA30C869232&#34;</span>,
  <span style="color:#e6db74">&#34;port&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">1</span>,
  <span style="color:#e6db74">&#34;counter&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">17</span>,
  <span style="color:#e6db74">&#34;payload_raw&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;CdgVLRGJAQAWzg==&#34;</span>,
}
</code></pre></div><p>Not super helpful. I did find a <strong>super</strong> helpful website that would help me translate that into something more meaningful. Go <a href="https://cryptii.com/pipes/base64-to-hex">Crypti.com</a> and paste in your raw, base-64-encoded data, and it will &hellip; translate it to Hexadecimal. Hmm &hellip; still not what I want to see. It turns out, in order to get the data in a usable form, you have to go back to your TTN console and click on the <code>Payload Formats</code> tab. From here, we will decode the Hex into something we can actually use.</p>
<p>Remember, we send an array of bytes. I pasted the base-64-encoded message into that website above, and got the following:</p>
<p><img src="/posts/category/iot-iot-software/images/Screen-Shot-2019-10-09-at-2.34.09-PM.png" alt=""></p>
<p>It decoded it into a series of bytes. Cool! Now to decode those bytes! (We&rsquo;re almost there, I promise!)</p>
<p>On your TTN Consoles <code>Payload Formats</code> tab, we will enter the following function (it&rsquo;s javascript!)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">Decoder</span>(<span style="color:#a6e22e">bytes</span>, <span style="color:#a6e22e">port</span>) {
  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">decoded</span> <span style="color:#f92672">=</span> {};

  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">cInt</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">bytes</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">|</span> <span style="color:#a6e22e">bytes</span>[<span style="color:#ae81ff">1</span>]; <span style="color:#75715e">// temperature ºC
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rem</span> <span style="color:#f92672">=</span>(<span style="color:#a6e22e">bytes</span>[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">|</span> <span style="color:#a6e22e">bytes</span>[<span style="color:#ae81ff">3</span>]; <span style="color:#75715e">// humidity %
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">pre</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">bytes</span>[<span style="color:#ae81ff">4</span>]) <span style="color:#f92672">+</span> <span style="color:#75715e">// pressure is a 4-byte value
</span><span style="color:#75715e"></span>  ((<span style="color:#a6e22e">bytes</span>[<span style="color:#ae81ff">5</span>]) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">8</span>)
    <span style="color:#f92672">+</span> ((<span style="color:#a6e22e">bytes</span>[<span style="color:#ae81ff">6</span>]) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">16</span>)
    <span style="color:#f92672">+</span> ((<span style="color:#a6e22e">bytes</span>[<span style="color:#ae81ff">7</span>]) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">24</span>) ;
  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">alt</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">bytes</span>[<span style="color:#ae81ff">8</span>] <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">bytes</span>[<span style="color:#ae81ff">9</span>];
  <span style="color:#75715e">// Decode integer to float
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">decoded</span>.<span style="color:#a6e22e">temp_c</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">cInt</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">100</span>;
  <span style="color:#a6e22e">decoded</span>.<span style="color:#a6e22e">humidity</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rem</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">100</span>;
  <span style="color:#a6e22e">decoded</span>.<span style="color:#a6e22e">pressure</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">pre</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">100</span>;
  <span style="color:#a6e22e">decoded</span>.<span style="color:#a6e22e">altitude</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">alt</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">100</span>;

  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">decoded</span>;
}
</code></pre></div><p>I&rsquo;ll step through what we&rsquo;re doing here. If we look back at the data buffer we sent, you&rsquo;ll remember that the first 2 bytes were the temperature. So we strip off those 2 bytes and store those in a temperature variable. We strip off the next 2 and that&rsquo;s our humidity. We then need to grab the 4 bytes of the pressure, and finally the last 2 bytes for the altitude. Finally, we decode those back into their original floating-point state, and we&rsquo;re done! Now if we look at what&rsquo;s coming out of our MQTT broker, we will see:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">{
  <span style="color:#e6db74">&#34;app_id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;my-temp-app&#34;</span>,
  <span style="color:#e6db74">&#34;dev_id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;my-device&#34;</span>,
  <span style="color:#e6db74">&#34;hardware_serial&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;009E9BA30C869232&#34;</span>,
  <span style="color:#e6db74">&#34;port&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">1</span>,
  <span style="color:#e6db74">&#34;counter&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">28</span>,
  <span style="color:#e6db74">&#34;payload_raw&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;CeEVJg6JAQAW7A==&#34;</span>,
  <span style="color:#e6db74">&#34;payload_fields&#34;</span><span style="color:#f92672">:</span>{
  <span style="color:#e6db74">&#34;altitude&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">58.68</span>,
  <span style="color:#e6db74">&#34;humidity&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">54.14</span>,
  <span style="color:#e6db74">&#34;pressure&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">1006.22</span>,
  <span style="color:#e6db74">&#34;temp_c&#34;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">25.29</span>
},
}
</code></pre></div><p>Which is a proper JSON object, with our data in a usable form! Now for the final bit: getting it all into InfluxDB!</p>
<h2 id="getting-it-into-influxdb">Getting it into InfluxDB</h2>
<p>Luckily this is the easiest part of the whole thing thanks to telegraf! On your telegraf host, edit your <code>telegraf.conf</code>{.language-markup} file. Look for the section entitled Read metrics from MQTT topic(s) and add the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml">[[<span style="color:#ae81ff">inputs.mqtt_consumer]]</span>
<span style="color:#ae81ff">servers = [&#34;tcp://us-west.thethings.network:1883&#34;]</span>
<span style="color:#ae81ff">qos = 0</span>
<span style="color:#ae81ff">connection_timeout = &#34;30s&#34;</span>
<span style="color:#ae81ff">topics = [ &#34;+/devices/+/up&#34; ]</span>
<span style="color:#ae81ff">client_id = &#34;ttn&#34;</span>
<span style="color:#ae81ff">username = &#34;APP_NAMEr&#34;</span>
<span style="color:#ae81ff">password = &#34;APPKEY&#34;</span>
<span style="color:#ae81ff">data_format = &#34;json&#34;</span>
</code></pre></div><p>Then restart telegraf, and, like magic, you should be getting data into InfluxDB! If I go look in my data explorer in Chronograf, I should see a new measurement called <code>mqtt_consumer</code>{.language-markup} and in there &hellip; Whoa!! A lot of data fields! It turns out that TTN provides a bunch of additional data about how the device connected and sent its data, and that is all preserved by the telegraf plugin.</p>
<p><img src="/posts/category/iot-iot-software/images/data1.gif" alt=""></p>
<p>Your sensor data will have <code>payload_fields_</code>{.language-markup} prepended to it. All the rest is data <strong>about</strong> your data.</p>
<p>As usual, the easiest part of almost any deployment I do is the InfluxDB part. Once I had the data coming out of the MQTT broker in the proper format, having it stored in InfluxDB took just a few lines of configuration. I can now build a dashboard of my temperature, humidity, pressure and altitude data in Chronograf.</p>

        
        

        
        
        
        


        


        
        
        
        
        
        
          
        
        
        </div>

        
        
          <div class="btn-improve-page">
              <a href="https://github.com/davidgs/website/edit//content/posts/category/iot/sensing-with-the-things-network.md">
                <i class="fas fa-code-branch"></i>
                Improve this page
              </a>
          </div>
        

        
      <hr />
        <div class="row next-prev-navigator">


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
      
      <div class="col-md-6 previous-article">
        <a href="/posts/category/database/iot-data-from-other-sources-mysql/" class="btn btn-outline-info">
          <span><i class="fas fa-chevron-circle-left"></i> Prev</span>
          <br />
          <span>IoT Data from Other Sources MySQL</span>
        </a>
      </div>
      
    
    
      
        
        
          
              
          
        
        <div class="col-md-6 next-article">
          <a href="/posts/category/programming/hiding-complexity-with-custom-functions-calculating-heat-index/" class="btn btn-outline-info">
            <span>Next <i class="fas fa-chevron-circle-right"></i></span>
            <br />
            <span>Hiding Complexity with Custom Functions Calculating Heat Index</span>
          </a>
        </div>
      
    
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

</div>

      <hr />
      
      
      </div>
    </div>
  </div>
  
</section>


      
      
  <section class="toc-section" id="toc-section">
    
    <div class="toc-holder">
      <h5 class="text-center pl-3">Table of Contents</h5>
      <hr>
      <div class="toc">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#the-hardware">The hardware</a></li>
    <li><a href="#the-software">The software</a></li>
    <li><a href="#getting-the-data">Getting the data</a></li>
    <li><a href="#getting-it-into-influxdb">Getting it into InfluxDB</a></li>
  </ul>
</nav>
      </div>
    </div>
    
  </section>

    </div>

    

  




  




  
  
    
  









  







<footer class="container-fluid text-center align-content-center footer pb-2">
  <div class="container pt-5">
    <div class="row text-left">
      <div class="col-md-4 col-sm-12">
        <h5>Navigation</h5>
        
        <ul>
            
              
              
                
              
              <li class="nav-item">
                <a class="smooth-scroll" href="#about">About</a>
              </li>
            
            
              
              
                
              
              <li class="nav-item">
                <a class="smooth-scroll" href="#skills">Skills</a>
              </li>
            
            
              
              
                
              
              <li class="nav-item">
                <a class="smooth-scroll" href="#experiences">Experience</a>
              </li>
            
            
              
              
                
              
              <li class="nav-item">
                <a class="smooth-scroll" href="#education">Education</a>
              </li>
            
            
              
              
                
              
              <li class="nav-item">
                <a class="smooth-scroll" href="#projects">Projects</a>
              </li>
            
            
              
              
                
              
              <li class="nav-item">
                <a class="smooth-scroll" href="#recent-posts">Recent Posts</a>
              </li>
            
        </ul>
        

      </div>
      
      <div class="col-md-4 col-sm-12">
        <h5>Contact me:</h5>
        <ul>
          
          <li><span>Email: </span> <span>davidgs@davidgs.com</span></li>
          
          <li><span>Phone: </span> <span>&#43;1 (919) 534-5099</span></li>
          
        </ul>
      </div>
      
      
    </div>
  </div>
  <hr />
  <div class="container">
    <div class="row text-left">
      <div class="col-md-4">
        <a id="theme" href="https://github.com/hossainemruz/toha" target="#">
          <img src="/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_2.png">
          Toha
        </a>
      </div>
      <div class="col-md-4 text-center">© 2020 Copyright.</div>
      <div class="col-md-4 text-right">
        <a id="hugo" href="https://gohugo.io/">Powered by
        <img
          src="/images/hugo-logo.svg"
          alt="Hugo Logo"
          height="18"
        />
        </a>
      </div>
    </div>
  </div>
</footer>

    <script src="/js/jquery-3.4.1.min.js"></script>
<script src="/js/popper.min.js"></script>
<script src="/js/bootstrap.min.js"></script>

<script src="/js/navbar.js"></script>
<script src="/js/main.js"></script>


    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>
<script src="/js/single.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>



    
    
<script type="text/javascript">
  var sc_project = 4739013;
  var sc_invisible = 0;
  var sc_security = "3147012e";
  var scJsHost = "https://";
  document.write("<sc" + "ript type='text/javascript' src='" +
    scJsHost +
    "statcounter.com/counter/counter.js'></" + "script>");
</script>
<noscript>
  <div class="statcounter"><a title="Web Analytics" href="https://statcounter.com/" target="_blank"><img
        class="statcounter" src="https://c.statcounter.com/4739013/0/3147012e/0/" alt="Web Analytics"></a></div>
</noscript>

  </body>
</html>
